<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Quick Quiz Timer</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<script src="problems.js"></script>
<style>
:root{--nc:#00f5ff;--ng:#39ff14;--np:#ff2d78;--ny:#ffea00;--nu:#bf00ff;--b0:#050510;--b1:#0a0a1e;--b2:#0f0f2a;--bg:rgba(0,245,255,0.22);--tm:#e0eaff;--td:#5a6a8a;}
*{box-sizing:border-box;margin:0;padding:0;touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{height:100%;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--b0);color:var(--tm);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background-image:linear-gradient(rgba(0,245,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.04) 1px,transparent 1px);background-size:40px 40px;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 50% 0%,rgba(0,245,255,0.07) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(191,0,255,0.07) 0%,transparent 50%);}

.screen{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px 80px;}
.hidden{display:none!important;}

.logo{font-family:'Orbitron',monospace;font-weight:900;font-size:clamp(1.4rem,5vw,2.2rem);letter-spacing:0.05em;text-align:center;margin-bottom:4px;color:var(--nc);text-shadow:0 0 20px var(--nc),0 0 60px rgba(0,245,255,0.3);line-height:1.1;}
.logo-sub{font-family:'Orbitron',monospace;font-size:0.6rem;letter-spacing:0.3em;color:var(--nu);text-align:center;text-shadow:0 0 12px var(--nu);margin-bottom:20px;}

.panel{background:var(--b2);border:1px solid var(--bg);border-radius:16px;box-shadow:0 0 30px rgba(0,245,255,0.05),inset 0 1px 0 rgba(255,255,255,0.04);padding:18px;width:100%;max-width:500px;position:relative;}
.panel+.panel{margin-top:12px;}
.ptitle{font-family:'Orbitron',monospace;font-size:0.68rem;letter-spacing:0.2em;color:var(--nc);text-align:center;margin-bottom:14px;text-shadow:0 0 10px var(--nc);}

.subj-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.subj-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.2);border-radius:12px;color:var(--tm);padding:16px 8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;font-size:0.78rem;font-weight:700;}
.subj-btn:hover{border-color:var(--nc);background:rgba(0,245,255,0.06);box-shadow:0 0 16px rgba(0,245,255,0.14);}
.subj-icon{font-size:1.7rem;}

/* tab bar */
.tab-bar{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px;}
.tab-bar::-webkit-scrollbar{height:3px;}
.tab-bar::-webkit-scrollbar-thumb{background:var(--nc);border-radius:2px;}
.tab{background:var(--b1);border:1px solid rgba(0,245,255,0.15);border-radius:8px;color:var(--td);padding:6px 12px;font-size:0.68rem;font-family:'Noto Sans JP',sans-serif;font-weight:700;cursor:pointer;transition:all 0.18s;white-space:nowrap;}
.tab.active{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.08);}

/* cat grid */
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;max-height:36vh;overflow-y:auto;padding-right:4px;margin-bottom:12px;}
.cat-grid::-webkit-scrollbar{width:3px;}
.cat-grid::-webkit-scrollbar-thumb{background:var(--nc);border-radius:2px;}
.cat-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.12);border-radius:8px;color:var(--td);padding:9px 8px;font-size:0.7rem;font-family:'Noto Sans JP',sans-serif;font-weight:500;cursor:pointer;text-align:center;transition:all 0.18s;line-height:1.3;}
.cat-btn:hover{border-color:rgba(0,245,255,0.35);color:var(--tm);}
.cat-btn.sel{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.08);box-shadow:0 0 8px rgba(0,245,255,0.1);}

.sel-badge{font-family:'Orbitron',monospace;font-size:0.65rem;color:var(--td);text-align:center;margin-bottom:10px;letter-spacing:0.1em;}
.sel-badge span{color:var(--nc);text-shadow:0 0 8px var(--nc);}

/* neon buttons */
.nbtn{border:none;border-radius:10px;font-family:'Orbitron',monospace;font-weight:700;cursor:pointer;transition:all 0.2s;letter-spacing:0.05em;}
.nbtn:disabled{opacity:0.28;cursor:not-allowed;}
.nbtn.cy{background:var(--nc);color:#000;box-shadow:0 0 20px rgba(0,245,255,0.4);}
.nbtn.cy:not(:disabled):hover{box-shadow:0 0 36px rgba(0,245,255,0.7);transform:translateY(-1px);}
.nbtn.pu{background:var(--nu);color:#fff;box-shadow:0 0 20px rgba(191,0,255,0.4);}
.nbtn.pu:not(:disabled):hover{box-shadow:0 0 36px rgba(191,0,255,0.7);transform:translateY(-1px);}
.nbtn.ye{background:var(--ny);color:#000;box-shadow:0 0 20px rgba(255,234,0,0.4);}
.nbtn.gn{background:var(--ng);color:#000;box-shadow:0 0 20px rgba(57,255,20,0.4);}
.nbtn.pk{background:var(--np);color:#fff;box-shadow:0 0 20px rgba(255,45,120,0.4);}
.nbtn.gh{background:none;border:1px solid var(--td);color:var(--td);}
.nbtn.gh:hover{border-color:var(--nc);color:var(--nc);}
.back-btn{background:none;border:1px solid var(--td);border-radius:8px;color:var(--td);padding:8px 20px;font-size:0.78rem;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;margin-top:10px;}
.back-btn:hover{border-color:var(--nc);color:var(--nc);}

/* mode row */
.mode-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px;}
.mode-btn{background:var(--b1);border:1px solid rgba(255,255,255,0.08);border-radius:8px;color:var(--td);padding:9px;font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;font-weight:700;cursor:pointer;transition:all 0.2s;}
.mode-btn.active{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.06);}
.mode-desc{font-size:0.66rem;color:var(--td);text-align:center;margin-bottom:12px;}

/* â”€â”€ TIMER SETTINGS (reusable) â”€â”€ */
.tsbox{background:var(--b1);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;margin-bottom:14px;}
.tstitle{font-family:'Orbitron',monospace;font-size:0.58rem;letter-spacing:0.2em;color:var(--td);text-align:center;margin-bottom:12px;}
.tsrow{display:grid;grid-template-columns:1fr 1px 1fr;align-items:center;}
.tsdiv{background:rgba(255,255,255,0.05);height:56px;}
.tsitem{display:flex;flex-direction:column;align-items:center;gap:6px;}
.tslbl{font-size:0.66rem;color:var(--td);}
.tsstep{display:flex;align-items:center;gap:6px;}
.tsbtngroup{display:flex;flex-direction:column;gap:3px;}
.tsbtn{background:var(--b2);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:var(--tm);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-family:'Orbitron',monospace;}
.tsbtn:hover{border-color:var(--nc);color:var(--nc);}
.tsbtn.big{width:34px;height:26px;font-size:0.72rem;}
.tsbtn.sml{width:34px;height:22px;font-size:0.58rem;}
.tsval{font-family:'Orbitron',monospace;font-size:1.5rem;font-weight:700;min-width:52px;text-align:center;}
.tsval.qc{color:var(--nu);text-shadow:0 0 10px var(--nu);}
.tsval.ac{color:var(--ng);text-shadow:0 0 10px var(--ng);}
.tssec{font-size:0.62rem;color:var(--td);}

/* overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.88);backdrop-filter:blur(6px);z-index:100;display:flex;align-items:center;justify-content:center;padding:16px;}
.overlay.hidden{display:none!important;}
.qcard{background:var(--b2);border:1px solid rgba(191,0,255,0.3);border-radius:20px;box-shadow:0 0 50px rgba(191,0,255,0.08);padding:20px;width:100%;max-width:480px;max-height:92vh;overflow-y:auto;}
.qcard::-webkit-scrollbar{width:3px;}
.qcard::-webkit-scrollbar-thumb{background:var(--nu);border-radius:2px;}

.tphase{font-family:'Orbitron',monospace;font-size:0.68rem;letter-spacing:0.2em;text-align:center;margin-bottom:8px;text-shadow:0 0 10px currentColor;}
.tphase.qp{color:var(--nu);}
.tphase.ap{color:var(--ng);}

.cdwrap{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.cdnum{font-family:'Orbitron',monospace;font-size:2.4rem;font-weight:900;min-width:76px;text-align:center;line-height:1;text-shadow:0 0 24px currentColor;transition:color 0.2s;}
.cdnum.qc{color:var(--nu);}
.cdnum.ac{color:var(--ng);}
.cdnum.warn{color:var(--np)!important;text-shadow:0 0 30px var(--np)!important;}
.ptrack{flex:1;height:8px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;}
.pfill{height:100%;border-radius:4px;}
.pfill.qf{background:linear-gradient(90deg,var(--nu),var(--nc));box-shadow:0 0 10px var(--nu);}
.pfill.af{background:linear-gradient(90deg,var(--ng),var(--nc));box-shadow:0 0 10px var(--ng);}

.tq{font-size:1rem;font-weight:700;text-align:center;padding:14px;background:var(--b1);border-radius:12px;border:1px solid rgba(191,0,255,0.2);margin-bottom:10px;line-height:1.5;}
.tans{padding:14px;border-radius:12px;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;margin-bottom:10px;min-height:64px;}
.tans.opts-phase{flex-direction:column;align-items:stretch;gap:5px;background:none;border:none;padding:0;min-height:auto;}
.topt{background:var(--b1);border:1px solid rgba(191,0,255,0.2);border-radius:8px;padding:8px 12px;font-size:0.85rem;display:flex;align-items:center;gap:10px;color:var(--tm);}
.topt-lbl{font-family:'Orbitron',monospace;font-size:0.6rem;color:var(--nu);min-width:16px;text-shadow:0 0 6px var(--nu);}

.tans.show{background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.4);color:var(--ng);box-shadow:0 0 20px rgba(57,255,20,0.06);}
.tansval{font-size:1.15rem;font-weight:700;}
.texp{font-size:0.75rem;color:var(--td);line-height:1.4;font-weight:400;}
.tcounter{text-align:center;font-family:'Orbitron',monospace;font-size:0.62rem;color:var(--td);letter-spacing:0.15em;margin-bottom:10px;}

.tctrl{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.tctrl .nbtn{padding:10px 4px;font-size:0.64rem;}

/* float + toast */
#floatBack{position:fixed;bottom:20px;left:20px;width:48px;height:48px;background:var(--b2);border:1px solid rgba(0,245,255,0.3);border-radius:50%;color:var(--nc);font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:50;box-shadow:0 0 16px rgba(0,245,255,0.15);transition:all 0.2s;}
#floatBack.hidden{display:none!important;}
#floatBack:hover{box-shadow:0 0 28px rgba(0,245,255,0.35);transform:scale(1.05);}
#toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--b2);border:1px solid var(--nc);border-radius:10px;padding:10px 20px;font-size:0.8rem;color:var(--nc);z-index:999;transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 0 20px rgba(0,245,255,0.2);white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);}

@keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(191,0,255,0.4)}50%{box-shadow:0 0 44px rgba(191,0,255,0.85)}}
.pulse{animation:pulse-glow 2s ease-in-out infinite;}
@keyframes timesup{0%{background:rgba(255,45,120,0.0)}20%{background:rgba(255,45,120,0.18)}100%{background:rgba(255,45,120,0.0)}}
.timesup-flash{animation:timesup 0.4s ease-out;}
@keyframes flash{0%,100%{opacity:1}50%{opacity:0.3}}
.flash{animation:flash 0.15s ease-in-out;}
input,select{font-size:16px;}
@media(max-width:380px){.cat-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<!-- â•â•â• MAIN â•â•â• -->
<div id="mainScreen" class="screen">
  <div class="logo">QUICK QUIZ<br>TIMER</div>
  <div class="logo-sub">NEON STUDY MODE</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT SUBJECT</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="goSubj('social')"><span class="subj-icon">ğŸŒ</span><span>ç¤¾ä¼š</span></button>
      <button class="subj-btn" onclick="goSubj('science')"><span class="subj-icon">ğŸ”¬</span><span>ç†ç§‘</span></button>
      <button class="subj-btn" onclick="goSubj('english')"><span class="subj-icon">ğŸ“–</span><span>è‹±èª</span></button>
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">â–¶ å…¨æ•™ç§‘ã‹ã‚‰é¸ã¶</div>
    <button class="nbtn cy" onclick="goAll()" style="width:100%;padding:14px;font-size:0.8rem;">ğŸŒ ALL SUBJECTS</button>
  </div>
</div>

<!-- â•â•â• SOCIAL â•â•â• -->
<div id="socialScreen" class="screen hidden">
  <div class="logo">ç¤¾ä¼š</div><div class="logo-sub">SOCIAL STUDIES</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="openCat('geography','social')"><span class="subj-icon">ğŸ—ºï¸</span><span>åœ°ç†</span></button>
      <button class="subj-btn" onclick="openCat('history','social')"><span class="subj-icon">ğŸ›ï¸</span><span>æ­´å²</span></button>
      <button class="subj-btn" onclick="openCat('civics','social')"><span class="subj-icon">âš–ï¸</span><span>å…¬æ°‘</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['geography','history','civics'],'ğŸŒ ç¤¾ä¼šã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ ç¤¾ä¼šã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• SCIENCE â•â•â• -->
<div id="scienceScreen" class="screen hidden">
  <div class="logo">ç†ç§‘</div><div class="logo-sub">SCIENCE</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid" style="grid-template-columns:repeat(2,1fr);">
      <button class="subj-btn" onclick="openCat('chemistry','science')"><span class="subj-icon">ğŸ§ª</span><span>åŒ–å­¦</span></button>
      <button class="subj-btn" onclick="openCat('biology','science')"><span class="subj-icon">ğŸ§¬</span><span>ç”Ÿç‰©</span></button>
      <button class="subj-btn" onclick="openCat('physics','science')"><span class="subj-icon">âš›ï¸</span><span>ç‰©ç†</span></button>
      <button class="subj-btn" onclick="openCat('earth','science')"><span class="subj-icon">ğŸŒ</span><span>åœ°å­¦</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['chemistry','biology','physics','earth'],'ğŸ”¬ ç†ç§‘ã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ ç†ç§‘ã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• ENGLISH â•â•â• -->
<div id="englishScreen" class="screen hidden">
  <div class="logo">è‹±èª</div><div class="logo-sub">ENGLISH</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="openCat('english_words','english')"><span class="subj-icon">ğŸ“</span><span>è‹±å˜èª</span></button>
      <button class="subj-btn" onclick="openCat('english_phrases','english')"><span class="subj-icon">ğŸ’¬</span><span>è‹±ç†Ÿèª</span></button>
      <button class="subj-btn" onclick="openCat('english_grammar','english')"><span class="subj-icon">ğŸ“˜</span><span>èªå½¢å¤‰åŒ–</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['english_words','english_phrases','english_grammar'],'ğŸ“– è‹±èªã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ è‹±èªã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• CATEGORY SELECT â•â•â• -->
<div id="catScreen" class="screen hidden">
  <div class="logo" id="catLogo">åœ°ç†</div>
  <div class="logo-sub" id="catLogoSub">SELECT UNITS</div>
  <div class="panel">
    <div class="tab-bar hidden" id="tabBar"></div>
    <div class="ptitle" id="catPtitle">â–¶ å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
    <div class="sel-badge">é¸æŠä¸­: <span id="selCount">0</span> å˜å…ƒ</div>
    <div class="cat-grid" id="catGrid"></div>

    <!-- ã‚¿ã‚¤ãƒãƒ¼è¨­å®š (ã“ã“ã§æ±ºã‚ã‚‹) -->
    <div class="tsbox" id="catTsBox">
      <div class="tstitle">âš™ TIMER SETTINGS</div>
      <div class="tsrow">
        <div class="tsitem">
          <div class="tslbl">â“ å•é¡Œ</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('q',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval qc" id="tsQ">3.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('q',0.1)">+.1</button>
            </div>
          </div>
        </div>
        <div class="tsdiv"></div>
        <div class="tsitem">
          <div class="tslbl">ğŸ’¡ è§£ç­”</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('a',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval ac" id="tsA">5.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('a',0.1)">+.1</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å‡ºé¡Œé † -->
    <div class="mode-row">
      <button class="mode-btn active" id="mR" onclick="setMode('random')">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
      <button class="mode-btn" id="mS" onclick="setMode('seq')">ğŸ“‹ é †ç•ªé€šã‚Š</button>
    </div>
    <div class="mode-desc" id="mDesc">å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™</div>

    <button class="nbtn pu pulse" id="decideBtn" disabled onclick="decideAndStart()" style="width:100%;padding:16px;font-size:0.85rem;margin-top:4px;">â± DECIDE &amp; START</button>
    <div style="text-align:center"><button class="back-btn" id="catBack">â† æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• TIMER OVERLAY â•â•â• -->
<div id="timerOv" class="overlay hidden">
  <div class="qcard">
    <div class="tphase qp" id="tPhase">â“ QUESTION</div>
    <div class="cdwrap">
      <div class="cdnum qc" id="cdNum">3.0</div>
      <div class="ptrack"><div class="pfill qf" id="progFill" style="width:100%"></div></div>
    </div>
    <div class="tq" id="tQ"></div>
    <div class="tans" id="tAns"></div>
    <div class="tcounter" id="tCount">1 / 1</div>
    <div class="tctrl">
      <button class="nbtn ye" id="pauseBtn" onclick="togglePause()">â¸ åœæ­¢</button>
      <button class="nbtn gn" onclick="skipPhase()">â­ ã‚¹ã‚­ãƒƒãƒ—</button>
      <button class="nbtn pk" onclick="closeTimer()">âœ• çµ‚äº†</button>
    </div>
    <!-- å®Ÿè¡Œä¸­ã‚‚å¤‰æ›´å¯ -->
    <div class="tsbox">
      <div class="tstitle">âš™ LIVE SETTINGS</div>
      <div class="tsrow">
        <div class="tsitem">
          <div class="tslbl">â“ å•é¡Œ</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('q',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval qc" id="tsQ2">3.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('q',0.1)">+.1</button>
            </div>
          </div>
        </div>
        <div class="tsdiv"></div>
        <div class="tsitem">
          <div class="tslbl">ğŸ’¡ è§£ç­”</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('a',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval ac" id="tsA2">5.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('a',0.1)">+.1</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<button id="floatBack" class="hidden" onclick="goHome()">ğŸ“š</button>
<div id="toast"></div>

<script>
/* â•â•â•â•â•â• CATEGORY DATA â•â•â•â•â•â• */
const CAT = {
  geography:{label:'ğŸ—ºï¸ åœ°ç†',items:[
    {id:'geo_world_overview',name:'1.ä¸–ç•Œã®å§¿'},{id:'geo_japan_overview',name:'2.æ—¥æœ¬ã®å§¿'},{id:'geo_world_life',name:'3.ä¸–ç•Œå„åœ°ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},
    {id:'geo_asia',name:'4.ã‚¢ã‚¸ã‚¢å·'},{id:'geo_europe',name:'5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},{id:'geo_africa',name:'6.ã‚¢ãƒ•ãƒªã‚«å·'},
    {id:'geo_north_america',name:'7.åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_south_america',name:'8.å—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_oceania',name:'9.ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},
    {id:'geo_japan_features',name:'10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},{id:'geo_japan_kyushu',name:'11.ä¹å·åœ°æ–¹'},{id:'geo_japan_chugoku',name:'12.ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},
    {id:'geo_japan_kinki',name:'13.è¿‘ç•¿åœ°æ–¹'},{id:'geo_japan_chubu',name:'14.ä¸­éƒ¨åœ°æ–¹'},{id:'geo_japan_kanto',name:'15.é–¢æ±åœ°æ–¹'},
    {id:'geo_japan_tohoku',name:'16.æ±åŒ—åœ°æ–¹'},{id:'geo_japan_hokkaido',name:'17.åŒ—æµ·é“åœ°æ–¹'},
  ]},
  history:{label:'ğŸ›ï¸ æ­´å²',items:[
    {id:'hist_ancient',name:'1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬'},{id:'hist_ancient_state',name:'2.å¤ä»£å›½å®¶ã¨æ±ã‚¢ã‚¸ã‚¢'},{id:'hist_kamakura',name:'3.éŒå€‰å¹•åºœ'},
    {id:'hist_muromachi',name:'4.å®¤ç”ºå¹•åºœ'},{id:'hist_unification',name:'5.å…¨å›½çµ±ä¸€'},{id:'hist_edo_early',name:'6.æ±Ÿæˆ¸å¹•åºœã¨é–å›½'},
    {id:'hist_edo_develop',name:'7.ç”£æ¥­ã®ç™ºé”'},{id:'hist_opening',name:'8.æ—¥æœ¬ã®é–‹å›½'},{id:'hist_meiji',name:'9.æ˜æ²»ç¶­æ–°'},
    {id:'hist_wars',name:'10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰'},{id:'hist_wwi',name:'11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦'},{id:'hist_wwii',name:'12.ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},
    {id:'hist_postwar',name:'13.æˆ¦å¾Œã®ç™ºå±•'},
  ]},
  civics:{label:'âš–ï¸ å…¬æ°‘',items:[
    {id:'civics_modern',name:'1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},{id:'civics_constitution',name:'2.äººé–“ã®å°Šé‡ã¨æ†²æ³•'},
    {id:'civics_democracy',name:'3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},{id:'civics_economy',name:'4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'},
  ]},
  chemistry:{label:'ğŸ§ª åŒ–å­¦',items:[
    {id:'chemistry_basic',name:'1.ç‰©è³ªã¨ãã®æ€§è³ª'},{id:'chemistry_gas',name:'2.æ°—ä½“ã®æ€§è³ª'},{id:'chemistry_solution',name:'3.æ°´æº¶æ¶²ã®æ€§è³ª'},
    {id:'chemistry_state',name:'4.çŠ¶æ…‹å¤‰åŒ–'},{id:'chemistry_change',name:'5.ç‰©è³ªã®å¤‰åŒ–'},{id:'chemistry_structure',name:'6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},
    {id:'chemistry_reaction',name:'7.åŒ–å­¦å¤‰åŒ–'},{id:'chemistry_mass',name:'8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},{id:'chemistry_ion',name:'9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},
    {id:'chemistry_acid',name:'10.é…¸ãƒ»ã‚¢ãƒ«ã‚«ãƒªãƒ»å¡©'},{id:'chemistry_formula',name:'11.åŒ–å­¦å¼'},{id:'chemistry_reaction_equation',name:'12.åŒ–å­¦åå¿œå¼'},
    {id:'chemistry_ion_formula',name:'13.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼'},{id:'chemistry_ion_reaction',name:'14.ã‚¤ã‚ªãƒ³ã®åå¿œå¼'},
  ]},
  biology:{label:'ğŸ§¬ ç”Ÿç‰©',items:[
    {id:'biology_flower',name:'1.èŠ±ã®ã¤ãã‚Š'},{id:'biology_plant',name:'2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Š'},{id:'biology_animal',name:'3.å‹•ç‰©ã®åˆ†é¡'},
    {id:'biology_microscope',name:'4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},{id:'biology_cell',name:'5.ç”Ÿç‰©ã¨ç´°èƒ'},{id:'biology_plant_body',name:'6.æ¤ç‰©ã®ã‹ã‚‰ã '},
    {id:'biology_digestion',name:'7.æ¶ˆåŒ–ã¨å¸å'},{id:'biology_breathing',name:'8.å‘¼å¸'},{id:'biology_circulation',name:'9.è¡€æ¶²ã®å¾ªç’°'},
    {id:'biology_response',name:'10.åˆºæ¿€ã¨åå¿œ'},{id:'biology_growth',name:'11.ç”Ÿç‰©ã®æˆé•·'},{id:'biology_reproduction',name:'12.ç”Ÿç‰©ã®ç”Ÿæ®–'},
    {id:'biology_heredity',name:'13.éºä¼ã®è¦å‰‡æ€§'},{id:'biology_evolution',name:'14.ç”Ÿç‰©ã®é€²åŒ–'},{id:'biology_environment',name:'15.è‡ªç„¶ã¨ç’°å¢ƒ'},
  ]},
  physics:{label:'âš›ï¸ ç‰©ç†',items:[
    {id:'physics_light',name:'1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_sound',name:'2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_force',name:'3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},
    {id:'physics_current',name:'4.é›»æµã¨é›»åœ§'},{id:'physics_energy',name:'5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},{id:'physics_magnetic',name:'6.é›»æµã¨ç£ç•Œ'},
    {id:'physics_balance',name:'7.åŠ›ã®ã¤ã‚Šåˆã„'},{id:'physics_motion',name:'8.ç‰©ä½“ã®é‹å‹•'},{id:'physics_pressure',name:'9.æ°´åœ§ã¨æµ®åŠ›'},
    {id:'physics_work',name:'10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},{id:'physics_energy_change',name:'11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},{id:'physics_resources',name:'12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æº'},
  ]},
  earth:{label:'ğŸŒ åœ°å­¦',items:[
    {id:'earth_volcano',name:'1.ç«å±±'},{id:'earth_earthquake',name:'2.åœ°éœ‡'},{id:'earth_strata',name:'3.åœ°å±¤ã®ã§ãæ–¹'},
    {id:'earth_weather',name:'4.æ°—è±¡ã®è¦³æ¸¬'},{id:'earth_front',name:'5.æ°—å›£ã¨å‰ç·š'},{id:'earth_cloud',name:'6.é›²ã®ã§ãæ–¹'},
    {id:'earth_celestial',name:'7.å¤©ä½“ã®å‹•ã'},{id:'earth_solar',name:'8.å¤ªé™½ç³»ã®å¤©ä½“'},{id:'earth_moon',name:'9.æœˆã¨æƒ‘æ˜Ÿ'},
  ]},
  english_words:{label:'ğŸ“ è‹±å˜èª',items:[
    {id:'words_time',name:'æœˆãƒ»åºæ•°'},{id:'words_week',name:'æ›œæ—¥'},{id:'words_timeday',name:'æ™‚ãƒ»æ™‚é–“å¸¯'},
    {id:'words_season',name:'å­£ç¯€ãƒ»å®¶æ—'},{id:'words_sports',name:'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},{id:'words_job',name:'è·æ¥­ãƒ»äººãƒ»å»ºç‰©'},
    {id:'words_uncountable',name:'æ•°ãˆã‚‰ã‚Œãªã„åè©'},{id:'words_verb_important',name:'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},{id:'words_verb_various',name:'ã„ã‚ã„ã‚ãªæ„å‘³ã®å‹•è©'},
    {id:'words_verb_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹å‹•è©'},{id:'words_verb_other',name:'ãã®ä»–ã®é‡è¦å‹•è©'},{id:'words_adj_quantity',name:'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},
    {id:'words_adj_various',name:'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},{id:'words_adj_adv',name:'é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},{id:'words_adv_manner',name:'æ§˜å­ã‚’è¡¨ã™å‰¯è©'},
  ]},
  english_phrases:{label:'ğŸ’¬ è‹±ç†Ÿèª',items:[
    {id:'phrases_verb',name:'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},{id:'phrases_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹ç†Ÿèª'},{id:'phrases_similar',name:'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},
    {id:'phrases_verb_other',name:'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},{id:'phrases_be',name:'beå‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},{id:'phrases_quantity',name:'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},
    {id:'phrases_time_place',name:'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},{id:'phrases_important',name:'ãã®ä»–ã®é‡è¦ç†Ÿèª'},
  ]},
  english_grammar:{label:'ğŸ“˜ èªå½¢å¤‰åŒ–',items:[
    {id:'grammar_irregular_past',name:'ä¸è¦å‰‡å‹•è© - éå»å½¢'},{id:'grammar_irregular_same',name:'ä¸è¦å‰‡å‹•è© - åŒå½¢'},
    {id:'grammar_irregular_special',name:'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Š'},{id:'grammar_be_past',name:'beå‹•è© - éå»å½¢'},
    {id:'grammar_regular',name:'è¦å‰‡å‹•è©'},{id:'grammar_third_person',name:'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},{id:'grammar_ing',name:'å‹•è©ã®-ingå½¢'},
    {id:'grammar_comparative',name:'æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},{id:'grammar_more_most',name:'more/mostå½¢å®¹è©'},
    {id:'grammar_noun_plural',name:'åè©ã®è¤‡æ•°å½¢'},{id:'grammar_irregular_plural',name:'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},{id:'grammar_pronoun',name:'äººç§°ä»£åè©'},
  ]},
};

/* â•â•â•â•â•â• STATE â•â•â•â•â•â• */
let selIds = new Set();
let pool = [], qMode = 'random', seqI = 0;
let catMode = 'single', activeCatKey = '';
let tQ = 3.0, tA = 5.0;
let tPaused = false, tPhase = 'q', tProbs = [], tIdx = 0;
let tTout = null, tRaf = null;
// countdown SFX tracking
let lastBeepSec = -1;

/* â•â•â•â•â•â• SCREEN HELPERS â•â•â•â•â•â• */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  window.scrollTo(0,0);
}
function goSubj(s){ clk(); show(s+'Screen'); }
function goHome(){
  clk();
  selIds.clear();
  document.getElementById('floatBack').classList.add('hidden');
  show('mainScreen');
}

/* â•â•â•â•â•â• OPEN CAT (single field) â•â•â•â•â•â• */
function openCat(subj, backScreen){
  clk();
  catMode = 'single'; activeCatKey = subj;
  document.getElementById('catLogo').textContent    = CAT[subj].label;
  document.getElementById('catLogoSub').textContent = 'SELECT UNITS';
  document.getElementById('catPtitle').textContent  = 'â–¶ å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰';
  document.getElementById('tabBar').classList.add('hidden');
  renderGrid(subj);
  document.getElementById('catBack').onclick = ()=>{ clk(); show(backScreen+'Screen'); };
  show('catScreen');
}

/* â•â•â•â•â•â• OPEN ALL (tab mode) â•â•â•â•â•â• */
function goAll(){
  clk(); catMode='all';
  const keys = Object.keys(CAT);
  activeCatKey = keys[0];
  document.getElementById('catLogo').textContent    = 'ğŸŒ å…¨æ•™ç§‘';
  document.getElementById('catLogoSub').textContent = 'ALL SUBJECTS';
  document.getElementById('catPtitle').textContent  = 'â–¶ ã‚¿ãƒ–ã§åˆ†é‡ã‚’åˆ‡ã‚Šæ›¿ãˆã¦é¸æŠ';
  buildTabs(keys);
  renderGrid(activeCatKey);
  document.getElementById('catBack').onclick = ()=>{ clk(); show('mainScreen'); };
  show('catScreen');
}

/* â•â•â•â•â•â• ã¾ã‚‹ã”ã¨ â†’ catScreen ã§è¨­å®š â•â•â•â•â•â• */
function openAll(subjects, label){
  clk();
  catMode = 'all-preset';
  // å…¨å˜å…ƒã‚’é¸æŠæ¸ˆã¿ã«ã™ã‚‹
  selIds.clear();
  subjects.forEach(s=>CAT[s].items.forEach(c=>selIds.add(c.id)));
  // ã‚¿ãƒ–è¡¨ç¤º
  activeCatKey = subjects[0];
  document.getElementById('catLogo').textContent    = label;
  document.getElementById('catLogoSub').textContent = 'ALL UNITS SELECTED';
  document.getElementById('catPtitle').textContent  = 'â–¶ å˜å…ƒã®è¿½åŠ ãƒ»å¤‰æ›´ã‚‚ã§ãã¾ã™';
  buildTabs(subjects);
  renderGrid(activeCatKey);
  document.getElementById('catBack').onclick = ()=>{ clk(); show('mainScreen'); };
  show('catScreen');
}

function buildTabs(keys){
  const bar = document.getElementById('tabBar');
  bar.innerHTML = '';
  bar.classList.remove('hidden');
  keys.forEach(k=>{
    const t = document.createElement('button');
    t.className = 'tab' + (k===activeCatKey?' active':'');
    t.textContent = CAT[k].label;
    t.dataset.key = k;
    t.onclick = ()=>{ clk(); activeCatKey=k; document.querySelectorAll('.tab').forEach(tb=>tb.classList.toggle('active',tb.dataset.key===k)); renderGrid(k); };
    bar.appendChild(t);
  });
}

/* â•â•â•â•â•â• RENDER GRID â•â•â•â•â•â• */
function renderGrid(key){
  const grid = document.getElementById('catGrid');
  grid.innerHTML = '';
  const allIds = CAT[key].items.map(c=>c.id);
  const allSel = allIds.every(id=>selIds.has(id));

  // ã™ã¹ã¦é¸æŠ/è§£é™¤ãƒœã‚¿ãƒ³
  const allBtn = document.createElement('button');
  allBtn.className = 'cat-btn' + (allSel?' sel':'');
  allBtn.style.cssText = 'grid-column:1/-1;border-style:dashed;font-family:"Orbitron",monospace;font-size:0.65rem;letter-spacing:0.1em;';
  allBtn.textContent = allSel ? 'âœ“ ã™ã¹ã¦è§£é™¤' : 'ï¼‹ ã™ã¹ã¦é¸æŠ';
  allBtn.onclick = ()=>{
    clk();
    const ns = allIds.every(id=>selIds.has(id));
    if(ns){ allIds.forEach(id=>selIds.delete(id)); }
    else  { allIds.forEach(id=>selIds.add(id)); }
    renderGrid(key);
  };
  grid.appendChild(allBtn);

  CAT[key].items.forEach(c=>{
    const b = document.createElement('button');
    b.className = 'cat-btn' + (selIds.has(c.id)?' sel':'');
    b.textContent = c.name;
    b.onclick = ()=>{
      clk();
      if(selIds.has(c.id)){ selIds.delete(c.id); b.classList.remove('sel'); }
      else                 { selIds.add(c.id);    b.classList.add('sel');    }
      const nowAll = allIds.every(id=>selIds.has(id));
      allBtn.textContent = nowAll?'âœ“ ã™ã¹ã¦è§£é™¤':'ï¼‹ ã™ã¹ã¦é¸æŠ';
      allBtn.classList.toggle('sel', nowAll);
      updateSelCount();
    };
    grid.appendChild(b);
  });
  updateSelCount();
}

function updateSelCount(){
  const n = selIds.size;
  document.getElementById('selCount').textContent = n;
  document.getElementById('decideBtn').disabled = (n===0);
}

function setMode(m){
  clk(); qMode=m;
  document.getElementById('mR').classList.toggle('active',m==='random');
  document.getElementById('mS').classList.toggle('active',m==='seq');
  document.getElementById('mDesc').textContent = m==='random'?'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™':'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã—ã¾ã™';
}

/* â•â•â•â•â•â• DECIDE & START â•â•â•â•â•â• */
function decideAndStart(){
  // build pool
  pool = [];
  selIds.forEach(id=>{
    if(typeof problemDatabase!=='undefined' && problemDatabase[id])
      pool = pool.concat(problemDatabase[id]);
  });
  if(pool.length===0){ toast('âš  å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  document.getElementById('floatBack').classList.remove('hidden');
  startTimer();
}

/* â•â•â•â•â•â• TIMER â•â•â•â•â•â• */
function startTimer(){
  suc();
  tProbs = qMode==='random'
    ? [...pool].sort(()=>Math.random()-0.5)
    : [...pool];
  tIdx=0; tPaused=false; lastBeepSec=-1;
  document.getElementById('pauseBtn').textContent='â¸ åœæ­¢';
  syncSettingsDisplay();
  document.getElementById('timerOv').classList.remove('hidden');
  showTQ();
}
function closeTimer(){
  clk(); killTimer();
  document.getElementById('timerOv').classList.add('hidden');
}

function showTQ(){
  tPhase='q';
  const q = tProbs[tIdx];
  document.getElementById('tPhase').textContent='â“ QUESTION';
  document.getElementById('tPhase').className='tphase qp';
  document.getElementById('tQ').textContent = q.q;
  document.getElementById('tCount').textContent = (tIdx+1)+' / '+tProbs.length;
  document.getElementById('cdNum').className='cdnum qc';
  document.getElementById('progFill').className='pfill qf';

  // é¸æŠè‚¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦è¡¨ç¤º
  const shuffled = [...q.opts].sort(()=>Math.random()-0.5);
  const labels = ['A','B','C','D'];
  const ta = document.getElementById('tAns');
  ta.className='tans opts-phase';
  ta.innerHTML = shuffled.map((opt,i)=>
    `<div class="topt"><span class="topt-lbl">${labels[i]}</span>${opt}</div>`
  ).join('');

  lastBeepSec = -1;
  if(!tPaused) countdown(tQ, showTA);
}

function showTA(){
  tPhase='a';
  const q = tProbs[tIdx];
  const ans = q.opts[q.ans];
  document.getElementById('tPhase').textContent='ğŸ’¡ ANSWER';
  document.getElementById('tPhase').className='tphase ap';
  const ta = document.getElementById('tAns');
  ta.className='tans show';
  ta.innerHTML=`<div class="tansval">âœ… ${ans}</div>${q.exp?`<div class="texp">${q.exp}</div>`:''}`;
  document.getElementById('cdNum').className='cdnum ac';
  document.getElementById('progFill').className='pfill af';
  lastBeepSec = -1;
  if(!tPaused) countdown(tA, ()=>{
    tIdx=(tIdx+1)%tProbs.length;
    if(tIdx===0) toast('ğŸ”„ ä¸€å‘¨ã—ã¾ã—ãŸï¼');
    showTQ();
  });
}

function countdown(secs, cb){
  killTimer();
  const dur = secs*1000, t0 = performance.now();
  function tick(now){
    const el = Math.max(0, dur-(now-t0));
    const dispSec = el/1000;
    const dispStr = dispSec.toFixed(1);
    const cdEl = document.getElementById('cdNum');
    cdEl.textContent = dispStr;
    document.getElementById('progFill').style.width = (el/dur*100)+'%';

    // â”€â”€ åŠ¹æœéŸ³ãƒ­ã‚¸ãƒƒã‚¯ â”€â”€
    const floorSec = Math.floor(dispSec);
    if(floorSec !== lastBeepSec && floorSec >= 0){
      lastBeepSec = floorSec;
      if(el <= 10){ // æ®‹ã‚Š10ç§’ä»¥å†…ã§ãƒ”ãƒƒ
        if(floorSec === 0){
          // 0ç§’ï¼æ™‚é–“åˆ‡ã‚Œ â†’ ãƒ“ãƒªãƒ“ãƒªï¼‹ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
          sfxDone();
          cdEl.classList.add('warn');
          document.querySelector('.qcard').classList.add('timesup-flash');
          setTimeout(()=>{ cdEl.classList.remove('warn'); document.querySelector('.qcard').classList.remove('timesup-flash'); }, 400);
        } else if(floorSec <= 3){
          // 3ãƒ»2ãƒ»1 â†’ é«˜ã‚ã®ãƒ“ãƒ¼ãƒ—
          sfxBeepHigh();
          cdEl.classList.add('warn');
          setTimeout(()=>cdEl.classList.remove('warn'), 200);
        } else {
          // 4ã€œ10 â†’ ä½ã‚ã®ãƒ“ãƒ¼ãƒ—
          sfxBeepLow();
        }
      }
    }

    if(el<=0){ cb(); return; }
    tRaf = requestAnimationFrame(tick);
  }
  tRaf = requestAnimationFrame(tick);
  tTout = setTimeout(cb, dur);
}

function killTimer(){ clearTimeout(tTout); cancelAnimationFrame(tRaf); tTout=null; tRaf=null; }

function togglePause(){
  clk(); tPaused=!tPaused;
  const b = document.getElementById('pauseBtn');
  if(tPaused){ killTimer(); b.textContent='â–¶ å†é–‹'; }
  else{ b.textContent='â¸ åœæ­¢'; lastBeepSec=-1; if(tPhase==='q') showTQ(); else showTA(); }
}
function skipPhase(){
  clk(); killTimer(); lastBeepSec=-1;
  if(tPhase==='q') showTA();
  else{ tIdx=(tIdx+1)%tProbs.length; if(tIdx===0)toast('ğŸ”„ ä¸€å‘¨ã—ã¾ã—ãŸï¼'); showTQ(); }
}
function chTime(t,d){
  clk();
  if(t==='q'){ tQ=Math.round(Math.max(0.1,Math.min(60,tQ+d))*10)/10; }
  else        { tA=Math.round(Math.max(0.1,Math.min(60,tA+d))*10)/10; }
  syncSettingsDisplay();
  // ã‚¿ã‚¤ãƒãƒ¼èµ·å‹•ä¸­ãªã‚‰å³ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ
  if(!tPaused && document.getElementById('timerOv').classList.contains('hidden')===false){
    killTimer(); lastBeepSec=-1;
    if(tPhase==='q') countdown(tQ, showTA);
    else countdown(tA, ()=>{ tIdx=(tIdx+1)%tProbs.length; if(tIdx===0)toast('ğŸ”„ ä¸€å‘¨ã—ã¾ã—ãŸï¼'); showTQ(); });
  }
}
function syncSettingsDisplay(){
  ['tsQ','tsQ2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=tQ.toFixed(1); });
  ['tsA','tsA2'].forEach(id=>{ const el=document.getElementById(id); if(el) el.textContent=tA.toFixed(1); });
}

/* â•â•â•â•â•â• SOUND ENGINE â•â•â•â•â•â• */
let ac = null;
function ga(){ if(!ac)try{ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){} if(ac&&ac.state==='suspended')ac.resume(); return ac; }
function tn(f,d,v=0.18,tp='sine'){
  const a=ga(); if(!a) return;
  const o=a.createOscillator(), g=a.createGain();
  o.connect(g); g.connect(a.destination);
  o.frequency.value=f; o.type=tp;
  g.gain.setValueAtTime(0,a.currentTime);
  g.gain.linearRampToValueAtTime(v,a.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);
  o.start(); o.stop(a.currentTime+d);
}

// é€šå¸¸ã‚¯ãƒªãƒƒã‚¯
function clk(){ tn(900,0.06,0.1,'square'); }
// START æˆåŠŸéŸ³
function suc(){ [523,659,784,1047].forEach((f,i)=>setTimeout(()=>tn(f,0.18,0.12),i*70)); }
// ã‚«ã‚¦ãƒ³ãƒˆä¸­ ä½ãƒ“ãƒ¼ãƒ—ï¼ˆ4ã€œ10ç§’ï¼‰
function sfxBeepLow(){ tn(440,0.08,0.12,'sine'); }
// ã‚«ã‚¦ãƒ³ãƒˆä¸­ é«˜ãƒ“ãƒ¼ãƒ—ï¼ˆ3ãƒ»2ãƒ»1ï¼‰
function sfxBeepHigh(){ tn(880,0.1,0.2,'sine'); }
// 0ç§’ï¼æ™‚é–“åˆ‡ã‚Œ â€” ãƒ“ãƒªãƒ“ãƒªâ†’ãƒ–ãƒ¼ãƒ³
function sfxDone(){
  const a=ga(); if(!a) return;
  const now = a.currentTime;
  // ã‚¬ã‚¬ã‚¬ãƒƒï¼ˆçŸ­ã„ãƒãƒ¼ã‚¹ãƒˆÃ—3ï¼‰
  [0, 0.07, 0.14].forEach(offset=>{
    const o=a.createOscillator(), g=a.createGain();
    o.connect(g); g.connect(a.destination);
    o.type='sawtooth'; o.frequency.value=180;
    g.gain.setValueAtTime(0, now+offset);
    g.gain.linearRampToValueAtTime(0.45, now+offset+0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now+offset+0.06);
    o.start(now+offset); o.stop(now+offset+0.07);
  });
  // ãƒ–ãƒ¼ãƒ¼ãƒ³ï¼ˆä½éŸ³ãƒ­ãƒ³ã‚°ï¼‰
  const o2=a.createOscillator(), g2=a.createGain();
  o2.connect(g2); g2.connect(a.destination);
  o2.type='square'; o2.frequency.setValueAtTime(90, now+0.18);
  o2.frequency.exponentialRampToValueAtTime(40, now+0.7);
  g2.gain.setValueAtTime(0, now+0.18);
  g2.gain.linearRampToValueAtTime(0.35, now+0.22);
  g2.gain.exponentialRampToValueAtTime(0.001, now+0.75);
  o2.start(now+0.18); o2.stop(now+0.76);
}
// ä¸€å‘¨
function sfxLap(){ [784,659,523].forEach((f,i)=>setTimeout(()=>tn(f,0.15,0.15),i*80)); }

/* â”€â”€ TOAST â”€â”€ */
let tT;
function toast(m){
  const e=document.getElementById('toast');
  e.textContent=m; e.classList.add('show');
  clearTimeout(tT); tT=setTimeout(()=>e.classList.remove('show'),2500);
  if(m.includes('ä¸€å‘¨')) sfxLap();
}

document.addEventListener('click',()=>{ if(ac&&ac.state==='suspended')ac.resume(); },{once:true});
</script>
</body>
</html>