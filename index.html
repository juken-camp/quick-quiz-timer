<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>Quick Quiz Timer</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<script src="problems.js"></script>
<style>
:root{
  --nc:#00f5ff;--ng:#39ff14;--np:#ff2d78;--ny:#ffea00;--nu:#bf00ff;
  --b0:#050510;--b1:#0a0a1e;--b2:#0f0f2a;
  --bg:rgba(0,245,255,0.22);--tm:#e0eaff;--td:#5a6a8a;
}
*{box-sizing:border-box;margin:0;padding:0;touch-action:manipulation;-webkit-tap-highlight-color:transparent;user-select:none;}
html,body{height:100%;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--b0);color:var(--tm);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,245,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.04) 1px,transparent 1px);
  background-size:40px 40px;}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:radial-gradient(ellipse at 50% 0%,rgba(0,245,255,0.07) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 100%,rgba(191,0,255,0.07) 0%,transparent 50%);}

.screen{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px 80px;}
.hidden{display:none!important;}
.logo{font-family:'Orbitron',monospace;font-weight:900;font-size:clamp(1.4rem,5vw,2.2rem);letter-spacing:0.05em;text-align:center;margin-bottom:4px;color:var(--nc);text-shadow:0 0 20px var(--nc),0 0 60px rgba(0,245,255,0.3);line-height:1.1;}
.logo-sub{font-family:'Orbitron',monospace;font-size:0.6rem;letter-spacing:0.3em;color:var(--nu);text-align:center;text-shadow:0 0 12px var(--nu);margin-bottom:20px;}
.panel{background:var(--b2);border:1px solid var(--bg);border-radius:16px;box-shadow:0 0 30px rgba(0,245,255,0.05),inset 0 1px 0 rgba(255,255,255,0.04);padding:18px;width:100%;max-width:500px;}
.panel+.panel{margin-top:12px;}
.ptitle{font-family:'Orbitron',monospace;font-size:0.68rem;letter-spacing:0.2em;color:var(--nc);text-align:center;margin-bottom:14px;text-shadow:0 0 10px var(--nc);}
.subj-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.subj-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.2);border-radius:12px;color:var(--tm);padding:16px 8px;display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;font-size:0.78rem;font-weight:700;}
.subj-btn:hover{border-color:var(--nc);background:rgba(0,245,255,0.06);box-shadow:0 0 16px rgba(0,245,255,0.14);}
.subj-icon{font-size:1.7rem;}
.tab-bar{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px;}
.tab-bar::-webkit-scrollbar{height:3px;}
.tab-bar::-webkit-scrollbar-thumb{background:var(--nc);border-radius:2px;}
.tab{background:var(--b1);border:1px solid rgba(0,245,255,0.15);border-radius:8px;color:var(--td);padding:6px 12px;font-size:0.68rem;font-family:'Noto Sans JP',sans-serif;font-weight:700;cursor:pointer;transition:all 0.18s;white-space:nowrap;}
.tab.active{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.08);}
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;max-height:36vh;overflow-y:auto;padding-right:4px;margin-bottom:12px;}
.cat-grid::-webkit-scrollbar{width:3px;}
.cat-grid::-webkit-scrollbar-thumb{background:var(--nc);border-radius:2px;}
.cat-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.12);border-radius:8px;color:var(--td);padding:9px 8px;font-size:0.7rem;font-family:'Noto Sans JP',sans-serif;font-weight:500;cursor:pointer;text-align:center;transition:all 0.18s;line-height:1.3;}
.cat-btn:hover{border-color:rgba(0,245,255,0.35);color:var(--tm);}
.cat-btn.sel{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.08);box-shadow:0 0 8px rgba(0,245,255,0.1);}
.sel-badge{font-family:'Orbitron',monospace;font-size:0.65rem;color:var(--td);text-align:center;margin-bottom:10px;letter-spacing:0.1em;}
.sel-badge span{color:var(--nc);text-shadow:0 0 8px var(--nc);}
.nbtn{border:none;border-radius:10px;font-family:'Orbitron',monospace;font-weight:700;cursor:pointer;transition:all 0.2s;letter-spacing:0.05em;}
.nbtn:disabled{opacity:0.28;cursor:not-allowed;}
.nbtn.cy{background:var(--nc);color:#000;box-shadow:0 0 20px rgba(0,245,255,0.4);}
.nbtn.cy:not(:disabled):hover{box-shadow:0 0 36px rgba(0,245,255,0.7);transform:translateY(-1px);}
.nbtn.pu{background:var(--nu);color:#fff;box-shadow:0 0 20px rgba(191,0,255,0.4);}
.nbtn.pu:not(:disabled):hover{box-shadow:0 0 36px rgba(191,0,255,0.7);transform:translateY(-1px);}
.nbtn.ye{background:var(--ny);color:#000;box-shadow:0 0 20px rgba(255,234,0,0.4);}
.nbtn.gn{background:var(--ng);color:#000;box-shadow:0 0 20px rgba(57,255,20,0.4);}
.nbtn.pk{background:var(--np);color:#fff;box-shadow:0 0 20px rgba(255,45,120,0.4);}
.back-btn{background:none;border:1px solid var(--td);border-radius:8px;color:var(--td);padding:8px 20px;font-size:0.78rem;cursor:pointer;transition:all 0.2s;font-family:'Noto Sans JP',sans-serif;margin-top:10px;}
.back-btn:hover{border-color:var(--nc);color:var(--nc);}
.mode-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:6px;}
.mode-btn{background:var(--b1);border:1px solid rgba(255,255,255,0.08);border-radius:8px;color:var(--td);padding:9px;font-size:0.72rem;font-family:'Noto Sans JP',sans-serif;font-weight:700;cursor:pointer;transition:all 0.2s;}
.mode-btn.active{border-color:var(--nc);color:var(--nc);background:rgba(0,245,255,0.06);}
.mode-desc{font-size:0.66rem;color:var(--td);text-align:center;margin-bottom:12px;}
.tsbox{background:var(--b1);border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:14px;margin-bottom:14px;}
.tstitle{font-family:'Orbitron',monospace;font-size:0.58rem;letter-spacing:0.2em;color:var(--td);text-align:center;margin-bottom:12px;}
.tsrow{display:grid;grid-template-columns:1fr 1px 1fr;align-items:center;}
.tsdiv{background:rgba(255,255,255,0.05);height:56px;}
.tsitem{display:flex;flex-direction:column;align-items:center;gap:6px;}
.tslbl{font-size:0.66rem;color:var(--td);}
.tsstep{display:flex;align-items:center;gap:6px;}
.tsbtngroup{display:flex;flex-direction:column;gap:3px;}
.tsbtn{background:var(--b2);border:1px solid rgba(255,255,255,0.1);border-radius:5px;color:var(--tm);font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-family:'Orbitron',monospace;}
.tsbtn:hover{border-color:var(--nc);color:var(--nc);}
.tsbtn.big{width:34px;height:26px;font-size:0.72rem;}
.tsbtn.sml{width:34px;height:22px;font-size:0.58rem;}
.tsval{font-family:'Orbitron',monospace;font-size:1.5rem;font-weight:700;min-width:52px;text-align:center;}
.tsval.qc{color:var(--nu);text-shadow:0 0 10px var(--nu);}
.tsval.ac{color:var(--ng);text-shadow:0 0 10px var(--ng);}
.tssec{font-size:0.62rem;color:var(--td);}

/* â”€â”€ TIMER OVERLAY (full screen fixed) â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.92);backdrop-filter:blur(6px);z-index:100;display:flex;align-items:stretch;justify-content:center;}
.overlay.hidden{display:none!important;}
.qcard{background:var(--b2);border-left:1px solid rgba(191,0,255,0.3);border-right:1px solid rgba(191,0,255,0.3);width:100%;max-width:480px;display:flex;flex-direction:column;overflow:hidden;}
.qcard-top{padding:10px 16px 8px;flex-shrink:0;border-bottom:1px solid rgba(255,255,255,0.05);}
.qcard-mid{flex:1;overflow-y:auto;padding:10px 16px;min-height:0;}
.qcard-mid::-webkit-scrollbar{width:3px;}
.qcard-mid::-webkit-scrollbar-thumb{background:var(--nu);border-radius:2px;}
.qcard-bot{padding:8px 16px 12px;flex-shrink:0;border-top:1px solid rgba(255,255,255,0.05);overflow-y:auto;max-height:44vh;}
.qcard-bot::-webkit-scrollbar{width:3px;}
.qcard-bot::-webkit-scrollbar-thumb{background:var(--nu);border-radius:2px;}

/* â”€â”€ GAME HUD (top) â”€â”€ */
.hud{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;margin-bottom:8px;}
.hud-lives{display:flex;gap:3px;align-items:center;}
.hud-heart{font-size:1rem;transition:transform 0.2s;}
.hud-heart.lost{filter:grayscale(1);opacity:0.3;}
.hud-score-wrap{text-align:center;}
.hud-score{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:900;color:var(--ny);text-shadow:0 0 12px var(--ny);line-height:1;}
.hud-score-lbl{font-family:'Orbitron',monospace;font-size:0.45rem;color:var(--td);letter-spacing:0.2em;}
.hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
.hud-streak{font-family:'Orbitron',monospace;font-size:0.7rem;color:var(--np);text-shadow:0 0 8px var(--np);}
.hud-combo{font-family:'Orbitron',monospace;font-size:0.65rem;color:var(--ny);text-shadow:0 0 8px var(--ny);}
/* XP bar */
.xp-wrap{margin-bottom:6px;}
.xp-bar-track{height:4px;background:rgba(255,255,255,0.05);border-radius:2px;overflow:hidden;}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--nu),var(--nc));border-radius:2px;transition:width 0.4s ease;box-shadow:0 0 6px var(--nu);}
.xp-lbl{display:flex;justify-content:space-between;font-family:'Orbitron',monospace;font-size:0.48rem;color:var(--td);margin-top:2px;}

/* timer */
.tphase{font-family:'Orbitron',monospace;font-size:0.65rem;letter-spacing:0.2em;text-align:center;margin-bottom:6px;text-shadow:0 0 10px currentColor;}
.tphase.qp{color:var(--nu);}
.tphase.ap{color:var(--ng);}
.cdwrap{display:flex;align-items:center;gap:10px;}
.cdnum{font-family:'Orbitron',monospace;font-size:2.2rem;font-weight:900;min-width:72px;text-align:center;line-height:1;text-shadow:0 0 24px currentColor;transition:color 0.2s;}
.cdnum.qc{color:var(--nu);}
.cdnum.ac{color:var(--ng);}
.cdnum.warn{color:var(--np)!important;text-shadow:0 0 30px var(--np)!important;}
.ptrack{flex:1;height:7px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;}
.pfill{height:100%;border-radius:4px;}
.pfill.qf{background:linear-gradient(90deg,var(--nu),var(--nc));box-shadow:0 0 8px var(--nu);}
.pfill.af{background:linear-gradient(90deg,var(--ng),var(--nc));box-shadow:0 0 8px var(--ng);}

/* question + options */
.tq{font-size:0.95rem;font-weight:700;text-align:center;padding:12px;background:var(--b1);border-radius:12px;border:1px solid rgba(191,0,255,0.2);margin-bottom:9px;line-height:1.6;}
.tans{display:flex;flex-direction:column;gap:6px;}
.topt{background:var(--b1);border:1px solid rgba(191,0,255,0.25);border-radius:9px;padding:9px 12px;font-size:0.85rem;display:flex;align-items:center;gap:10px;color:var(--tm);cursor:pointer;text-align:left;font-family:'Noto Sans JP',sans-serif;font-weight:500;transition:border-color 0.12s,background 0.12s,box-shadow 0.12s;width:100%;}
.topt:not(:disabled):active{transform:scale(0.98);}
.topt:not(:disabled):hover{border-color:var(--nu);background:rgba(191,0,255,0.07);}
.topt.opt-correct{border-color:var(--ng)!important;background:rgba(57,255,20,0.1)!important;color:var(--ng)!important;box-shadow:0 0 14px rgba(57,255,20,0.25);}
.topt.opt-correct .topt-lbl{color:var(--ng)!important;text-shadow:0 0 8px var(--ng)!important;}
.topt.opt-wrong{border-color:var(--np)!important;background:rgba(255,45,120,0.1)!important;color:var(--np)!important;}
.topt.opt-wrong .topt-lbl{color:var(--np)!important;}
.topt-lbl{font-family:'Orbitron',monospace;font-size:0.6rem;color:var(--nu);min-width:16px;text-shadow:0 0 6px var(--nu);flex-shrink:0;}
.texp-inline{font-size:0.74rem;color:var(--td);background:rgba(57,255,20,0.04);border-radius:8px;padding:8px 12px;border:1px solid rgba(57,255,20,0.2);margin-top:2px;line-height:1.5;}

/* counter + controls */
.tcounter{text-align:center;font-family:'Orbitron',monospace;font-size:0.6rem;color:var(--td);letter-spacing:0.15em;margin-bottom:8px;}
.tctrl{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px;}
.tctrl .nbtn{padding:10px 4px;font-size:0.62rem;}

/* â”€â”€ FLOATING EFFECTS â”€â”€ */
.combo-popup{position:fixed;left:50%;transform:translateX(-50%);top:45%;font-family:'Orbitron',monospace;font-weight:900;pointer-events:none;z-index:300;animation:comboPop 0.9s ease-out forwards;}
@keyframes comboPop{0%{opacity:0;transform:translateX(-50%) scale(0.5)}20%{opacity:1;transform:translateX(-50%) scale(1.3)}60%{opacity:1;transform:translateX(-50%) scale(1)}100%{opacity:0;transform:translateX(-50%) translateY(-60px) scale(0.9)}}
.score-popup{position:fixed;pointer-events:none;z-index:300;font-family:'Orbitron',monospace;font-weight:700;animation:scorePop 1.2s ease-out forwards;}
@keyframes scorePop{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-80px)}}
.lvup-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:400;pointer-events:none;animation:lvupFade 1.8s ease-out forwards;}
@keyframes lvupFade{0%,30%{opacity:1}100%{opacity:0}}
.lvup-text{font-family:'Orbitron',monospace;font-weight:900;font-size:3rem;color:var(--ny);text-shadow:0 0 40px var(--ny),0 0 80px rgba(255,234,0,0.4);text-align:center;animation:lvupPulse 0.4s ease-out;}
@keyframes lvupPulse{0%{transform:scale(0.4)}60%{transform:scale(1.15)}100%{transform:scale(1)}}

/* screen flash */
@keyframes timesup{0%{background:rgba(255,45,120,0)}20%{background:rgba(255,45,120,0.2)}100%{background:rgba(255,45,120,0)}}
.timesup-flash{animation:timesup 0.4s ease-out;}
@keyframes comboFlash{0%{box-shadow:inset 0 0 0 2px transparent}50%{box-shadow:inset 0 0 0 2px var(--ny)}100%{box-shadow:inset 0 0 0 2px transparent}}
.combo-ring{animation:comboFlash 0.3s ease-out;}

/* â”€â”€ GAME OVER OVERLAY â”€â”€ */
#gameoverOv{position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;}
#gameoverOv.hidden{display:none!important;}
.go-card{background:var(--b2);border:2px solid var(--np);border-radius:20px;box-shadow:0 0 60px rgba(255,45,120,0.2);padding:28px 24px;width:100%;max-width:440px;text-align:center;}
.go-title{font-family:'Orbitron',monospace;font-size:2rem;font-weight:900;color:var(--np);text-shadow:0 0 30px var(--np);margin-bottom:4px;}
.go-rank{font-family:'Orbitron',monospace;font-size:3.5rem;font-weight:900;margin:10px 0;line-height:1;}
.go-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0;}
.go-stat{background:var(--b1);border-radius:10px;padding:12px 8px;}
.go-stat-val{font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:900;line-height:1;}
.go-stat-lbl{font-size:0.65rem;color:var(--td);margin-top:3px;}

/* float + toast */
#floatBack{position:fixed;bottom:20px;left:20px;width:48px;height:48px;background:var(--b2);border:1px solid rgba(0,245,255,0.3);border-radius:50%;color:var(--nc);font-size:1.2rem;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:50;box-shadow:0 0 16px rgba(0,245,255,0.15);transition:all 0.2s;}
#floatBack.hidden{display:none!important;}
#floatBack:hover{box-shadow:0 0 28px rgba(0,245,255,0.35);transform:scale(1.05);}
#toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--b2);border:1px solid var(--nc);border-radius:10px;padding:10px 20px;font-size:0.8rem;color:var(--nc);z-index:999;transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 0 20px rgba(0,245,255,0.2);white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);}

.sess-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:4px;}
.sess-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.15);border-radius:8px;color:var(--td);padding:8px 4px;font-size:0.72rem;font-family:"Orbitron",monospace;font-weight:700;cursor:pointer;transition:all 0.18s;letter-spacing:0.05em;}
.sess-btn:hover{border-color:var(--nc);color:var(--nc);}
.sess-btn.active{border-color:var(--ny);color:var(--ny);background:rgba(255,234,0,0.07);box-shadow:0 0 10px rgba(255,234,0,0.15);}
/* ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º */
.sess-timer{font-family:"Orbitron",monospace;font-size:0.72rem;font-weight:700;color:var(--ny);text-shadow:0 0 8px var(--ny);letter-spacing:0.1em;}
.sess-timer.warn{color:var(--np)!important;text-shadow:0 0 12px var(--np)!important;animation:sessPulse 0.5s ease-in-out infinite;}
@keyframes sessPulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 20px rgba(191,0,255,0.4)}50%{box-shadow:0 0 44px rgba(191,0,255,0.85)}}
.pulse{animation:pulse-glow 2s ease-in-out infinite;}
input,select{font-size:16px;}
@media(max-width:380px){.cat-grid{grid-template-columns:1fr;}}
.sess-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:4px;}
.sess-btn{background:var(--b1);border:1px solid rgba(0,245,255,0.15);border-radius:8px;color:var(--td);padding:8px 4px;font-size:0.72rem;font-family:"Orbitron",monospace;font-weight:700;cursor:pointer;transition:all 0.18s;letter-spacing:0.05em;}
.sess-btn:hover{border-color:var(--nc);color:var(--nc);}
.sess-btn.active{border-color:var(--ny);color:var(--ny);background:rgba(255,234,0,0.07);box-shadow:0 0 10px rgba(255,234,0,0.15);}
.sess-timer{font-family:"Orbitron",monospace;font-size:0.72rem;font-weight:700;color:var(--ny);text-shadow:0 0 8px var(--ny);letter-spacing:0.1em;}
.sess-timer.warn{color:var(--np)!important;text-shadow:0 0 12px var(--np)!important;animation:sessPulse 0.5s ease-in-out infinite;}
@keyframes sessPulse{0%,100%{opacity:1}50%{opacity:0.5}}
</style>
</head>
<body>

<!-- â•â•â• MAIN â•â•â• -->
<div id="mainScreen" class="screen">
  <div class="logo">QUICK QUIZ<br>TIMER</div>
  <div class="logo-sub">NEON STUDY MODE</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT SUBJECT</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="goSubj('social')"><span class="subj-icon">ğŸŒ</span><span>ç¤¾ä¼š</span></button>
      <button class="subj-btn" onclick="goSubj('science')"><span class="subj-icon">ğŸ”¬</span><span>ç†ç§‘</span></button>
      <button class="subj-btn" onclick="goSubj('english')"><span class="subj-icon">ğŸ“–</span><span>è‹±èª</span></button>
    </div>
  </div>
  <div class="panel">
    <div class="ptitle">â–¶ å…¨æ•™ç§‘ã‹ã‚‰é¸ã¶</div>
    <button class="nbtn cy" onclick="goAll()" style="width:100%;padding:14px;font-size:0.8rem;">ğŸŒ ALL SUBJECTS</button>
  </div>
</div>

<!-- â•â•â• SOCIAL â•â•â• -->
<div id="socialScreen" class="screen hidden">
  <div class="logo">ç¤¾ä¼š</div><div class="logo-sub">SOCIAL STUDIES</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="openCat('geography','social')"><span class="subj-icon">ğŸ—ºï¸</span><span>åœ°ç†</span></button>
      <button class="subj-btn" onclick="openCat('history','social')"><span class="subj-icon">ğŸ›ï¸</span><span>æ­´å²</span></button>
      <button class="subj-btn" onclick="openCat('civics','social')"><span class="subj-icon">âš–ï¸</span><span>å…¬æ°‘</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['geography','history','civics'],'ğŸŒ ç¤¾ä¼šã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ ç¤¾ä¼šã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• SCIENCE â•â•â• -->
<div id="scienceScreen" class="screen hidden">
  <div class="logo">ç†ç§‘</div><div class="logo-sub">SCIENCE</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid" style="grid-template-columns:repeat(2,1fr);">
      <button class="subj-btn" onclick="openCat('chemistry','science')"><span class="subj-icon">ğŸ§ª</span><span>åŒ–å­¦</span></button>
      <button class="subj-btn" onclick="openCat('biology','science')"><span class="subj-icon">ğŸ§¬</span><span>ç”Ÿç‰©</span></button>
      <button class="subj-btn" onclick="openCat('physics','science')"><span class="subj-icon">âš›ï¸</span><span>ç‰©ç†</span></button>
      <button class="subj-btn" onclick="openCat('earth','science')"><span class="subj-icon">ğŸŒ</span><span>åœ°å­¦</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['chemistry','biology','physics','earth'],'ğŸ”¬ ç†ç§‘ã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ ç†ç§‘ã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• ENGLISH â•â•â• -->
<div id="englishScreen" class="screen hidden">
  <div class="logo">è‹±èª</div><div class="logo-sub">ENGLISH</div>
  <div class="panel">
    <div class="ptitle">â–¶ SELECT FIELD</div>
    <div class="subj-grid">
      <button class="subj-btn" onclick="openCat('english_words','english')"><span class="subj-icon">ğŸ“</span><span>è‹±å˜èª</span></button>
      <button class="subj-btn" onclick="openCat('english_phrases','english')"><span class="subj-icon">ğŸ’¬</span><span>è‹±ç†Ÿèª</span></button>
      <button class="subj-btn" onclick="openCat('english_grammar','english')"><span class="subj-icon">ğŸ“˜</span><span>èªå½¢å¤‰åŒ–</span></button>
    </div>
    <button class="nbtn cy" onclick="openAll(['english_words','english_phrases','english_grammar'],'ğŸ“– è‹±èªã¾ã‚‹ã”ã¨')" style="width:100%;padding:13px;font-size:0.75rem;margin-top:12px;">âš¡ è‹±èªã¾ã‚‹ã”ã¨</button>
    <div style="text-align:center"><button class="back-btn" onclick="show('mainScreen')">â† æ•™ç§‘é¸æŠã¸æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• CATEGORY SELECT â•â•â• -->
<div id="catScreen" class="screen hidden">
  <div class="logo" id="catLogo">åœ°ç†</div>
  <div class="logo-sub" id="catLogoSub">SELECT UNITS</div>
  <div class="panel">
    <div class="tab-bar hidden" id="tabBar"></div>
    <div class="ptitle" id="catPtitle">â–¶ å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
    <div class="sel-badge">é¸æŠä¸­: <span id="selCount">0</span> å˜å…ƒ</div>
    <div class="cat-grid" id="catGrid"></div>
    <div class="tsbox">
      <div class="tstitle">âš™ TIMER SETTINGS</div>
      <div class="tsrow">
        <div class="tsitem">
          <div class="tslbl">â“ å•é¡Œ</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('q',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval qc" id="tsQ">3.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('q',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('q',0.1)">+.1</button>
            </div>
          </div>
        </div>
        <div class="tsdiv"></div>
        <div class="tsitem">
          <div class="tslbl">ğŸ’¡ è§£ç­”</div>
          <div class="tsstep">
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',-1)">âˆ’1</button>
              <button class="tsbtn sml" onclick="chTime('a',-0.1)">âˆ’.1</button>
            </div>
            <span class="tsval ac" id="tsA">5.0</span>
            <span class="tssec">ç§’</span>
            <div class="tsbtngroup">
              <button class="tsbtn big" onclick="chTime('a',1)">+1</button>
              <button class="tsbtn sml" onclick="chTime('a',0.1)">+.1</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mode-row">
      <button class="mode-btn active" id="mR" onclick="setMode('random')">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
      <button class="mode-btn" id="mS" onclick="setMode('seq')">ğŸ“‹ é †ç•ªé€šã‚Š</button>
    </div>
    <div class="mode-desc" id="mDesc">å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™</div>

    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ -->
    <div class="ptitle" style="margin-top:10px;margin-bottom:8px;">â–¶ PLAY TIME</div>
    <div class="sess-grid" id="sessGrid">
      <button class="sess-btn" onclick="setSess(60)">1åˆ†</button>
      <button class="sess-btn" onclick="setSess(180)">3åˆ†</button>
      <button class="sess-btn active" onclick="setSess(300)">5åˆ†</button>
      <button class="sess-btn" onclick="setSess(600)">10åˆ†</button>
      <button class="sess-btn" onclick="setSess(0)">âˆ</button>
    </div>

    <button class="nbtn pu pulse" id="decideBtn" disabled onclick="decideAndStart()" style="width:100%;padding:16px;font-size:0.85rem;margin-top:10px;">â± DECIDE &amp; START</button>
    <div style="text-align:center"><button class="back-btn" id="catBack">â† æˆ»ã‚‹</button></div>
  </div>
</div>

<!-- â•â•â• TIMER OVERLAY â•â•â• -->
<div id="timerOv" class="overlay hidden">
  <div class="qcard" id="qcard">
    <div class="qcard-top">
      <!-- HUD -->
      <div class="hud">
        <div class="hud-lives" id="hudLives"></div>
        <div class="hud-score-wrap">
          <div class="hud-score" id="hudScore">0</div>
          <div class="hud-score-lbl">SCORE</div>
        </div>
        <div class="hud-right">
          <div class="sess-timer" id="sessTimerDisp"></div>
          <div class="sess-timer" id="sessTimerDisp"></div>
          <div class="hud-streak" id="hudStreak"></div>
          <div class="hud-combo" id="hudCombo"></div>
        </div>
      </div>
      <!-- XP bar -->
      <div class="xp-wrap">
        <div class="xp-bar-track"><div class="xp-bar-fill" id="xpFill" style="width:0%"></div></div>
        <div class="xp-lbl"><span id="xpLvl">LV 1</span><span id="xpVal">0 / 100 XP</span></div>
      </div>
      <!-- Timer -->
      <div class="tphase qp" id="tPhase">â“ QUESTION</div>
      <div class="cdwrap">
        <div class="cdnum qc" id="cdNum">3.0</div>
        <div class="ptrack"><div class="pfill qf" id="progFill" style="width:100%"></div></div>
      </div>
    </div>
    <div class="qcard-mid">
      <div class="tq" id="tQ">â€”</div>
      <div class="tans" id="tAns"></div>
    </div>
    <div class="qcard-bot">
      <div class="tcounter" id="tCount">1 / 1</div>
      <div class="tctrl">
        <button class="nbtn ye" id="pauseBtn" onclick="togglePause()">â¸ åœæ­¢</button>
        <button class="nbtn gn" onclick="skipPhase()">â­ ã‚¹ã‚­ãƒƒãƒ—</button>
        <button class="nbtn pk" onclick="closeTimer()">âœ• çµ‚äº†</button>
      </div>
      <div class="tsbox" style="margin-bottom:0;">
        <div class="tstitle">âš™ LIVE SETTINGS</div>
        <div class="tsrow">
          <div class="tsitem">
            <div class="tslbl">â“ å•é¡Œ</div>
            <div class="tsstep">
              <div class="tsbtngroup">
                <button class="tsbtn big" onclick="chTime('q',-1)">âˆ’1</button>
                <button class="tsbtn sml" onclick="chTime('q',-0.1)">âˆ’.1</button>
              </div>
              <span class="tsval qc" id="tsQ2">3.0</span>
              <span class="tssec">ç§’</span>
              <div class="tsbtngroup">
                <button class="tsbtn big" onclick="chTime('q',1)">+1</button>
                <button class="tsbtn sml" onclick="chTime('q',0.1)">+.1</button>
              </div>
            </div>
          </div>
          <div class="tsdiv"></div>
          <div class="tsitem">
            <div class="tslbl">ğŸ’¡ è§£ç­”</div>
            <div class="tsstep">
              <div class="tsbtngroup">
                <button class="tsbtn big" onclick="chTime('a',-1)">âˆ’1</button>
                <button class="tsbtn sml" onclick="chTime('a',-0.1)">âˆ’.1</button>
              </div>
              <span class="tsval ac" id="tsA2">5.0</span>
              <span class="tssec">ç§’</span>
              <div class="tsbtngroup">
                <button class="tsbtn big" onclick="chTime('a',1)">+1</button>
                <button class="tsbtn sml" onclick="chTime('a',0.1)">+.1</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• GAME OVER â•â•â• -->
<div id="gameoverOv" class="hidden">
  <div class="go-card">
    <div class="go-title">GAME OVER</div>
    <div class="go-rank" id="goRank">â€”</div>
    <div class="go-stats">
      <div class="go-stat"><div class="go-stat-val" id="goScore" style="color:var(--ny)">0</div><div class="go-stat-lbl">SCORE</div></div>
      <div class="go-stat"><div class="go-stat-val" id="goStreak" style="color:var(--np)">0</div><div class="go-stat-lbl">MAX STREAK</div></div>
      <div class="go-stat"><div class="go-stat-val" id="goCorrect" style="color:var(--ng)">0</div><div class="go-stat-lbl">CORRECT</div></div>
      <div class="go-stat"><div class="go-stat-val" id="goTotal" style="color:var(--nc)">0</div><div class="go-stat-lbl">TOTAL</div></div>
    </div>
    <button class="nbtn pu" onclick="retryGame()" style="width:100%;padding:14px;font-size:0.82rem;margin-bottom:10px;">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
    <button class="nbtn cy" onclick="goHome()" style="width:100%;padding:12px;font-size:0.78rem;">ğŸ  ãƒˆãƒƒãƒ—ã¸</button>
  </div>
</div>

<button id="floatBack" class="hidden" onclick="goHome()">ğŸ“š</button>
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CAT = {
  geography:{label:'ğŸ—ºï¸ åœ°ç†',items:[
    {id:'geo_world_overview',name:'1.ä¸–ç•Œã®å§¿'},{id:'geo_japan_overview',name:'2.æ—¥æœ¬ã®å§¿'},{id:'geo_world_life',name:'3.ä¸–ç•Œå„åœ°ã®ç”Ÿæ´»ã¨ç’°å¢ƒ'},
    {id:'geo_asia',name:'4.ã‚¢ã‚¸ã‚¢å·'},{id:'geo_europe',name:'5.ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å·'},{id:'geo_africa',name:'6.ã‚¢ãƒ•ãƒªã‚«å·'},
    {id:'geo_north_america',name:'7.åŒ—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_south_america',name:'8.å—ã‚¢ãƒ¡ãƒªã‚«å·'},{id:'geo_oceania',name:'9.ã‚ªã‚»ã‚¢ãƒ‹ã‚¢'},
    {id:'geo_japan_features',name:'10.æ—¥æœ¬ã®åœ°åŸŸçš„ç‰¹è‰²'},{id:'geo_japan_kyushu',name:'11.ä¹å·åœ°æ–¹'},{id:'geo_japan_chugoku',name:'12.ä¸­å›½ãƒ»å››å›½åœ°æ–¹'},
    {id:'geo_japan_kinki',name:'13.è¿‘ç•¿åœ°æ–¹'},{id:'geo_japan_chubu',name:'14.ä¸­éƒ¨åœ°æ–¹'},{id:'geo_japan_kanto',name:'15.é–¢æ±åœ°æ–¹'},
    {id:'geo_japan_tohoku',name:'16.æ±åŒ—åœ°æ–¹'},{id:'geo_japan_hokkaido',name:'17.åŒ—æµ·é“åœ°æ–¹'},
  ]},
  history:{label:'ğŸ›ï¸ æ­´å²',items:[
    {id:'hist_ancient',name:'1.æ–‡æ˜ã®ãŠã“ã‚Šã¨æ—¥æœ¬'},{id:'hist_ancient_state',name:'2.å¤ä»£å›½å®¶ã¨æ±ã‚¢ã‚¸ã‚¢'},{id:'hist_kamakura',name:'3.éŒå€‰å¹•åºœ'},
    {id:'hist_muromachi',name:'4.å®¤ç”ºå¹•åºœ'},{id:'hist_unification',name:'5.å…¨å›½çµ±ä¸€'},{id:'hist_edo_early',name:'6.æ±Ÿæˆ¸å¹•åºœã¨é–å›½'},
    {id:'hist_edo_develop',name:'7.ç”£æ¥­ã®ç™ºé”'},{id:'hist_opening',name:'8.æ—¥æœ¬ã®é–‹å›½'},{id:'hist_meiji',name:'9.æ˜æ²»ç¶­æ–°'},
    {id:'hist_wars',name:'10.æ—¥æ¸…ãƒ»æ—¥éœ²æˆ¦äº‰'},{id:'hist_wwi',name:'11.ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ¦'},{id:'hist_wwii',name:'12.ç¬¬äºŒæ¬¡ä¸–ç•Œå¤§æˆ¦'},
    {id:'hist_postwar',name:'13.æˆ¦å¾Œã®ç™ºå±•'},
  ]},
  civics:{label:'âš–ï¸ å…¬æ°‘',items:[
    {id:'civics_modern',name:'1.ç¾ä»£ç¤¾ä¼šã¨ç§ãŸã¡'},{id:'civics_constitution',name:'2.äººé–“ã®å°Šé‡ã¨æ†²æ³•'},
    {id:'civics_democracy',name:'3.ç¾ä»£ã®æ°‘ä¸»æ”¿æ²»'},{id:'civics_economy',name:'4.æš®ã‚‰ã—ã¨çµŒæ¸ˆ'},
  ]},
  chemistry:{label:'ğŸ§ª åŒ–å­¦',items:[
    {id:'chemistry_basic',name:'1.ç‰©è³ªã¨ãã®æ€§è³ª'},{id:'chemistry_gas',name:'2.æ°—ä½“ã®æ€§è³ª'},{id:'chemistry_solution',name:'3.æ°´æº¶æ¶²ã®æ€§è³ª'},
    {id:'chemistry_state',name:'4.çŠ¶æ…‹å¤‰åŒ–'},{id:'chemistry_change',name:'5.ç‰©è³ªã®å¤‰åŒ–'},{id:'chemistry_structure',name:'6.ç‰©è³ªã®æˆã‚Šç«‹ã¡'},
    {id:'chemistry_reaction',name:'7.åŒ–å­¦å¤‰åŒ–'},{id:'chemistry_mass',name:'8.åŒ–å­¦å¤‰åŒ–ã¨è³ªé‡'},{id:'chemistry_ion',name:'9.ã‚¤ã‚ªãƒ³ã¨é›»æ± '},
    {id:'chemistry_acid',name:'10.é…¸ãƒ»ã‚¢ãƒ«ã‚«ãƒªãƒ»å¡©'},{id:'chemistry_formula',name:'11.åŒ–å­¦å¼'},{id:'chemistry_reaction_equation',name:'12.åŒ–å­¦åå¿œå¼'},
    {id:'chemistry_ion_formula',name:'13.ã‚¤ã‚ªãƒ³ã®åŒ–å­¦å¼'},{id:'chemistry_ion_reaction',name:'14.ã‚¤ã‚ªãƒ³ã®åå¿œå¼'},
  ]},
  biology:{label:'ğŸ§¬ ç”Ÿç‰©',items:[
    {id:'biology_flower',name:'1.èŠ±ã®ã¤ãã‚Š'},{id:'biology_plant',name:'2.æ ¹ãƒ»è‘‰ã®ã¤ãã‚Š'},{id:'biology_animal',name:'3.å‹•ç‰©ã®åˆ†é¡'},
    {id:'biology_microscope',name:'4.é¡•å¾®é¡ã®ä½¿ã„æ–¹'},{id:'biology_cell',name:'5.ç”Ÿç‰©ã¨ç´°èƒ'},{id:'biology_plant_body',name:'6.æ¤ç‰©ã®ã‹ã‚‰ã '},
    {id:'biology_digestion',name:'7.æ¶ˆåŒ–ã¨å¸å'},{id:'biology_breathing',name:'8.å‘¼å¸'},{id:'biology_circulation',name:'9.è¡€æ¶²ã®å¾ªç’°'},
    {id:'biology_response',name:'10.åˆºæ¿€ã¨åå¿œ'},{id:'biology_growth',name:'11.ç”Ÿç‰©ã®æˆé•·'},{id:'biology_reproduction',name:'12.ç”Ÿç‰©ã®ç”Ÿæ®–'},
    {id:'biology_heredity',name:'13.éºä¼ã®è¦å‰‡æ€§'},{id:'biology_evolution',name:'14.ç”Ÿç‰©ã®é€²åŒ–'},{id:'biology_environment',name:'15.è‡ªç„¶ã¨ç’°å¢ƒ'},
  ]},
  physics:{label:'âš›ï¸ ç‰©ç†',items:[
    {id:'physics_light',name:'1.å…‰ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_sound',name:'2.éŸ³ã«ã‚ˆã‚‹ç¾è±¡'},{id:'physics_force',name:'3.åŠ›ã«ã‚ˆã‚‹ç¾è±¡'},
    {id:'physics_current',name:'4.é›»æµã¨é›»åœ§'},{id:'physics_energy',name:'5.é›»æ°—ã‚¨ãƒãƒ«ã‚®ãƒ¼'},{id:'physics_magnetic',name:'6.é›»æµã¨ç£ç•Œ'},
    {id:'physics_balance',name:'7.åŠ›ã®ã¤ã‚Šåˆã„'},{id:'physics_motion',name:'8.ç‰©ä½“ã®é‹å‹•'},{id:'physics_pressure',name:'9.æ°´åœ§ã¨æµ®åŠ›'},
    {id:'physics_work',name:'10.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ä»•äº‹'},{id:'physics_energy_change',name:'11.ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç§»ã‚Šå¤‰ã‚ã‚Š'},{id:'physics_resources',name:'12.ã‚¨ãƒãƒ«ã‚®ãƒ¼è³‡æº'},
  ]},
  earth:{label:'ğŸŒ åœ°å­¦',items:[
    {id:'earth_volcano',name:'1.ç«å±±'},{id:'earth_earthquake',name:'2.åœ°éœ‡'},{id:'earth_strata',name:'3.åœ°å±¤ã®ã§ãæ–¹'},
    {id:'earth_weather',name:'4.æ°—è±¡ã®è¦³æ¸¬'},{id:'earth_front',name:'5.æ°—å›£ã¨å‰ç·š'},{id:'earth_cloud',name:'6.é›²ã®ã§ãæ–¹'},
    {id:'earth_celestial',name:'7.å¤©ä½“ã®å‹•ã'},{id:'earth_solar',name:'8.å¤ªé™½ç³»ã®å¤©ä½“'},{id:'earth_moon',name:'9.æœˆã¨æƒ‘æ˜Ÿ'},
  ]},
  english_words:{label:'ğŸ“ è‹±å˜èª',items:[
    {id:'words_time',name:'æœˆãƒ»åºæ•°'},{id:'words_week',name:'æ›œæ—¥'},{id:'words_timeday',name:'æ™‚ãƒ»æ™‚é–“å¸¯'},
    {id:'words_season',name:'å­£ç¯€ãƒ»å®¶æ—'},{id:'words_sports',name:'ã‚¹ãƒãƒ¼ãƒ„ãƒ»æ•™ç§‘'},{id:'words_job',name:'è·æ¥­ãƒ»äººãƒ»å»ºç‰©'},
    {id:'words_uncountable',name:'æ•°ãˆã‚‰ã‚Œãªã„åè©'},{id:'words_verb_important',name:'å…¥è©¦å¿…å‡ºé‡è¦å‹•è©'},{id:'words_verb_various',name:'ã„ã‚ã„ã‚ãªæ„å‘³ã®å‹•è©'},
    {id:'words_verb_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹å‹•è©'},{id:'words_verb_other',name:'ãã®ä»–ã®é‡è¦å‹•è©'},{id:'words_adj_quantity',name:'æ•°ãƒ»é‡ã‚’è¡¨ã™å½¢å®¹è©'},
    {id:'words_adj_various',name:'ã„ã‚ã„ã‚ãªå½¢å®¹è©'},{id:'words_adj_adv',name:'é‡è¦å½¢å®¹è©ãƒ»å‰¯è©'},{id:'words_adv_manner',name:'æ§˜å­ã‚’è¡¨ã™å‰¯è©'},
  ]},
  english_phrases:{label:'ğŸ’¬ è‹±ç†Ÿèª',items:[
    {id:'phrases_verb',name:'ã‚ˆãå‡ºã‚‹å‹•è©ã®ç†Ÿèª'},{id:'phrases_set',name:'ã‚»ãƒƒãƒˆã§è¦šãˆã‚‹ç†Ÿèª'},{id:'phrases_similar',name:'æ„å‘³ã®ä¼¼ã¦ã„ã‚‹ç†Ÿèª'},
    {id:'phrases_verb_other',name:'ãã®ä»–ã®å‹•è©ã®ç†Ÿèª'},{id:'phrases_be',name:'beå‹•è©ã‚’ä½¿ã£ãŸç†Ÿèª'},{id:'phrases_quantity',name:'æ•°ã‚„é‡ã‚’è¡¨ã™ç†Ÿèª'},
    {id:'phrases_time_place',name:'æ™‚ãƒ»å ´æ‰€ã‚’è¡¨ã™ç†Ÿèª'},{id:'phrases_important',name:'ãã®ä»–ã®é‡è¦ç†Ÿèª'},
  ]},
  english_grammar:{label:'ğŸ“˜ èªå½¢å¤‰åŒ–',items:[
    {id:'grammar_irregular_past',name:'ä¸è¦å‰‡å‹•è© - éå»å½¢'},{id:'grammar_irregular_same',name:'ä¸è¦å‰‡å‹•è© - åŒå½¢'},
    {id:'grammar_irregular_special',name:'ä¸è¦å‰‡å‹•è© - ç‰¹æ®Š'},{id:'grammar_be_past',name:'beå‹•è© - éå»å½¢'},
    {id:'grammar_regular',name:'è¦å‰‡å‹•è©'},{id:'grammar_third_person',name:'ä¸‰äººç§°å˜æ•°ç¾åœ¨å½¢'},{id:'grammar_ing',name:'å‹•è©ã®-ingå½¢'},
    {id:'grammar_comparative',name:'æ¯”è¼ƒç´šãƒ»æœ€ä¸Šç´š'},{id:'grammar_more_most',name:'more/mostå½¢å®¹è©'},
    {id:'grammar_noun_plural',name:'åè©ã®è¤‡æ•°å½¢'},{id:'grammar_irregular_plural',name:'ä¸è¦å‰‡ãªè¤‡æ•°å½¢'},{id:'grammar_pronoun',name:'äººç§°ä»£åè©'},
  ]},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let selIds = new Set(), pool = [], qMode = 'random';
let sessLimit = 300; // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆç§’ï¼‰0=ç„¡åˆ¶é™
let sessRemain = 0, sessTout = null, sessRaf = null;
let catMode = 'single', activeCatKey = '';
let tQ = 3.0, tA = 5.0;
let tPaused = false, tPhase = 'q', tProbs = [], tIdx = 0;
let tTout = null, tRaf = null, lastBeepSec = -1;
let qStartTime = 0; // for time bonus

/* â”€â”€ GAME STATE â”€â”€ */
let gScore = 0, gStreak = 0, gMaxStreak = 0;
let gCombo = 0;   // é€£ç¶šæ­£è§£æ•°
let gLives = 3;
let gCorrect = 0, gTotal = 0;
let gLevel = 1, gXP = 0;
const XP_PER_LEVEL = [100,150,200,250,300,350,400,500,600,800]; // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®å¿…è¦XP

/* ã‚³ãƒ³ãƒœå€ç‡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆé€£ç¶šæ­£è§£æ•°â†’å€ç‡ï¼‰ */
function comboMult(c){
  if(c < 3)  return 1;
  if(c < 5)  return 1.5;
  if(c < 8)  return 2;
  if(c < 12) return 3;
  if(c < 20) return 5;
  return 8; // 20é€£ç¶šä»¥ä¸Šã§æœ€å¤§8å€
}
function comboLabel(c){
  if(c < 3)  return '';
  if(c < 5)  return 'ğŸ”¥ COMBO x1.5';
  if(c < 8)  return 'âš¡ COMBO x2';
  if(c < 12) return 'ğŸ’¥ COMBO x3';
  if(c < 20) return 'ğŸŒŸ COMBO x5';
  return 'ğŸ‘‘ MAX x8';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  window.scrollTo(0,0);
}
function goSubj(s){ clk(); show(s+'Screen'); }
function goHome(){
  clk();
  selIds.clear();
  document.getElementById('floatBack').classList.add('hidden');
  document.getElementById('timerOv').classList.add('hidden');
  document.getElementById('gameoverOv').classList.add('hidden');
  show('mainScreen');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openCat(subj, backScreen){
  clk(); catMode='single'; activeCatKey=subj;
  document.getElementById('catLogo').textContent    = CAT[subj].label;
  document.getElementById('catLogoSub').textContent = 'SELECT UNITS';
  document.getElementById('catPtitle').textContent  = 'â–¶ å˜å…ƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰';
  document.getElementById('tabBar').classList.add('hidden');
  renderGrid(subj);
  document.getElementById('catBack').onclick = ()=>{ clk(); show(backScreen+'Screen'); };
  show('catScreen');
}
function goAll(){
  clk(); catMode='all';
  const keys = Object.keys(CAT); activeCatKey=keys[0];
  document.getElementById('catLogo').textContent    = 'ğŸŒ å…¨æ•™ç§‘';
  document.getElementById('catLogoSub').textContent = 'ALL SUBJECTS';
  document.getElementById('catPtitle').textContent  = 'â–¶ ã‚¿ãƒ–ã§åˆ†é‡ã‚’åˆ‡ã‚Šæ›¿ãˆã¦é¸æŠ';
  buildTabs(keys); renderGrid(activeCatKey);
  document.getElementById('catBack').onclick = ()=>{ clk(); show('mainScreen'); };
  show('catScreen');
}
function openAll(subjects, label){
  clk(); catMode='all-preset';
  selIds.clear();
  subjects.forEach(s=>CAT[s].items.forEach(c=>selIds.add(c.id)));
  activeCatKey=subjects[0];
  document.getElementById('catLogo').textContent    = label;
  document.getElementById('catLogoSub').textContent = 'ALL UNITS SELECTED';
  document.getElementById('catPtitle').textContent  = 'â–¶ å˜å…ƒã®è¿½åŠ ãƒ»å¤‰æ›´ã‚‚ã§ãã¾ã™';
  buildTabs(subjects); renderGrid(activeCatKey);
  document.getElementById('catBack').onclick = ()=>{ clk(); show('mainScreen'); };
  show('catScreen');
}
function buildTabs(keys){
  const bar = document.getElementById('tabBar');
  bar.innerHTML=''; bar.classList.remove('hidden');
  keys.forEach(k=>{
    const t=document.createElement('button');
    t.className='tab'+(k===activeCatKey?' active':'');
    t.textContent=CAT[k].label; t.dataset.key=k;
    t.onclick=()=>{ clk(); activeCatKey=k; document.querySelectorAll('.tab').forEach(tb=>tb.classList.toggle('active',tb.dataset.key===k)); renderGrid(k); };
    bar.appendChild(t);
  });
}
function renderGrid(key){
  const grid=document.getElementById('catGrid');
  grid.innerHTML='';
  const allIds=CAT[key].items.map(c=>c.id);
  const allSel=allIds.every(id=>selIds.has(id));
  const allBtn=document.createElement('button');
  allBtn.className='cat-btn'+(allSel?' sel':'');
  allBtn.style.cssText='grid-column:1/-1;border-style:dashed;font-family:"Orbitron",monospace;font-size:0.65rem;letter-spacing:0.1em;';
  allBtn.textContent=allSel?'âœ“ ã™ã¹ã¦è§£é™¤':'ï¼‹ ã™ã¹ã¦é¸æŠ';
  allBtn.onclick=()=>{ clk(); const ns=allIds.every(id=>selIds.has(id)); if(ns){allIds.forEach(id=>selIds.delete(id));}else{allIds.forEach(id=>selIds.add(id));} renderGrid(key); };
  grid.appendChild(allBtn);
  CAT[key].items.forEach(c=>{
    const b=document.createElement('button');
    b.className='cat-btn'+(selIds.has(c.id)?' sel':'');
    b.textContent=c.name;
    b.onclick=()=>{
      clk();
      if(selIds.has(c.id)){selIds.delete(c.id);b.classList.remove('sel');}else{selIds.add(c.id);b.classList.add('sel');}
      const nowAll=allIds.every(id=>selIds.has(id));
      allBtn.textContent=nowAll?'âœ“ ã™ã¹ã¦è§£é™¤':'ï¼‹ ã™ã¹ã¦é¸æŠ';
      allBtn.classList.toggle('sel',nowAll);
      updateSelCount();
    };
    grid.appendChild(b);
  });
  updateSelCount();
}
function updateSelCount(){
  const n=selIds.size;
  document.getElementById('selCount').textContent=n;
  document.getElementById('decideBtn').disabled=(n===0);
}
function setMode(m){
  clk(); qMode=m;
  document.getElementById('mR').classList.toggle('active',m==='random');
  document.getElementById('mS').classList.toggle('active',m==='seq');
  document.getElementById('mDesc').textContent=m==='random'?'å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™':'å•é¡Œã‚’é †ç•ªé€šã‚Šã«å‡ºé¡Œã—ã¾ã™';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DECIDE & START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setSess(secs){
  clk();
  sessLimit = secs;
  document.querySelectorAll('.sess-btn').forEach(b=>{
    const s = parseInt(b.getAttribute('onclick').match(/\d+/)?.[0]??'0');
    // âˆãƒœã‚¿ãƒ³ã¯secs=0
    const isInf = b.textContent==='âˆ';
    b.classList.toggle('active', isInf ? secs===0 : s===secs);
  });
}

function startSessTimer(){
  clearTimeout(sessTout); cancelAnimationFrame(sessRaf);
  if(sessLimit===0){
    document.getElementById('sessTimerDisp').textContent='';
    return;
  }
  sessRemain = sessLimit * 1000;
  const t0 = performance.now();
  function tick(now){
    if(tPaused){ sessRaf=requestAnimationFrame(tick); return; }
    const el = Math.max(0, sessRemain - (now - t0));
    const totalSec = Math.ceil(el/1000);
    const m = Math.floor(totalSec/60);
    const s = totalSec%60;
    const disp = (el===0)?'TIME UP':m+':'+String(s).padStart(2,'0');
    const el2 = document.getElementById('sessTimerDisp');
    el2.textContent = 'â° '+disp;
    el2.classList.toggle('warn', totalSec<=30);
    if(el<=0){ sessionEnd(); return; }
    // æ®‹ã‚Š30ç§’ã§ãƒ“ãƒ¼ãƒ—
    if(totalSec===30) sfxBeepHigh();
    if(totalSec<=10 && totalSec > 0 && s === totalSec) sfxBeepHigh();
    sessRaf = requestAnimationFrame(tick);
  }
  sessRaf = requestAnimationFrame(tick);
}

function stopSessTimer(){
  clearTimeout(sessTout); cancelAnimationFrame(sessRaf);
}

function sessionEnd(){
  stopSessTimer();
  document.getElementById('sessTimerDisp').textContent='â° TIME UP';
  // å°‘ã—å¾…ã£ã¦ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
  setTimeout(()=>{ killTimer(); gameOver(); }, 600);
}

function decideAndStart(){
  pool=[];
  selIds.forEach(id=>{ if(typeof problemDatabase!=='undefined'&&problemDatabase[id]) pool=pool.concat(problemDatabase[id]); });
  if(pool.length===0){ toast('âš  å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  document.getElementById('floatBack').classList.remove('hidden');
  resetGame();
  startTimer();
}
function retryGame(){
  document.getElementById('gameoverOv').classList.add('hidden');
  stopSessTimer();
  resetGame();
  startTimer();
}
function resetGame(){
  gScore=0; gStreak=0; gMaxStreak=0; gCombo=0;
  gLives=3; gCorrect=0; gTotal=0;
  gLevel=1; gXP=0;
  updateHUD();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onCorrect(elapsed){
  gCombo++; gStreak++;
  if(gStreak>gMaxStreak) gMaxStreak=gStreak;
  gCorrect++; gTotal++;

  // å¾—ç‚¹è¨ˆç®—: åŸºæœ¬100ç‚¹ + ã‚¿ã‚¤ãƒ ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæ®‹ã‚Šæ™‚é–“ãŒå¤šã„ã»ã©+æœ€å¤§100) Ã— ã‚³ãƒ³ãƒœå€ç‡
  const timeBonus = Math.floor((1 - Math.min(elapsed,tQ*1000)/(tQ*1000)) * 100);
  const mult = comboMult(gCombo);
  const pts = Math.floor((100 + timeBonus) * mult);
  gScore += pts;

  // XP
  const xp = Math.floor(20 * mult);
  addXP(xp);

  updateHUD();

  // ã‚³ãƒ³ãƒœæ¼”å‡º
  if(gCombo >= 3){
    showComboPopup(gCombo, mult);
    document.getElementById('qcard').classList.add('combo-ring');
    setTimeout(()=>document.getElementById('qcard').classList.remove('combo-ring'),300);
  }

  showScorePopup('+'+pts, '#ffea00');
  sfxCorrect();
}

function onMiss(){
  gCombo = 0; gStreak = 0;
  gTotal++;
  gLives--;
  updateHUD();
  sfxWrong();
  shakeHud();
  if(gLives <= 0) setTimeout(gameOver, 800);
}

function addXP(xp){
  gXP += xp;
  const need = xpNeeded(gLevel);
  if(gXP >= need){
    gXP -= need;
    gLevel++;
    showLevelUp();
    sfxLevelUp();
  }
  updateXPBar();
}
function xpNeeded(lv){
  return XP_PER_LEVEL[Math.min(lv-1, XP_PER_LEVEL.length-1)];
}

function updateHUD(){
  // Lives
  const lv = document.getElementById('hudLives');
  lv.innerHTML = '';
  for(let i=0;i<3;i++){
    const h=document.createElement('span');
    h.className='hud-heart'+(i>=gLives?' lost':'');
    h.textContent='â¤ï¸';
    lv.appendChild(h);
  }
  // Score
  document.getElementById('hudScore').textContent = gScore.toLocaleString();
  // Streak
  const se = document.getElementById('hudStreak');
  se.textContent = gStreak>0?'ğŸ”¥ '+gStreak+' STREAK':'';
  // Combo
  const ce = document.getElementById('hudCombo');
  ce.textContent = comboLabel(gCombo);
}
function updateXPBar(){
  const need = xpNeeded(gLevel);
  const pct = Math.min(100, (gXP/need)*100);
  document.getElementById('xpFill').style.width = pct+'%';
  document.getElementById('xpLvl').textContent = 'LV '+gLevel;
  document.getElementById('xpVal').textContent = gXP+' / '+need+' XP';
}

function shakeHud(){
  const h=document.getElementById('hudLives');
  h.style.animation='none';
  h.offsetWidth; // reflow
  h.style.animation='shakeX 0.4s ease';
}

function showComboPopup(combo, mult){
  const el=document.createElement('div');
  el.className='combo-popup';
  el.style.fontSize = Math.min(1.2+combo*0.06, 2.4)+'rem';
  el.style.color = mult>=5?'var(--np)':mult>=3?'var(--ny)':'var(--ng)';
  el.style.textShadow = '0 0 20px currentColor';
  el.textContent = combo+'ğŸ”¥ COMBO!';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 900);
}

function showScorePopup(text, color){
  const el=document.createElement('div');
  el.className='score-popup';
  el.style.cssText=`color:${color};font-size:1rem;left:${50+Math.random()*20-10}%;top:${40+Math.random()*10}%;text-shadow:0 0 10px ${color};`;
  el.textContent=text;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1200);
}

function showLevelUp(){
  const el=document.createElement('div');
  el.className='lvup-overlay';
  el.innerHTML=`<div class="lvup-text">LEVEL UP!<br>LV ${gLevel}</div>`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 1800);
}

function gameOver(){
  killTimer();
  document.getElementById('timerOv').classList.add('hidden');
  // Rank
  const rank = calcRank(gScore, gCorrect, gTotal);
  document.getElementById('goRank').textContent = rank.label;
  document.getElementById('goRank').style.color = rank.color;
  document.getElementById('goRank').style.textShadow = '0 0 30px '+rank.color;
  document.getElementById('goScore').textContent = gScore.toLocaleString();
  document.getElementById('goStreak').textContent = gMaxStreak;
  document.getElementById('goCorrect').textContent = gCorrect;
  document.getElementById('goTotal').textContent = gTotal;
  document.getElementById('gameoverOv').classList.remove('hidden');
  sfxGameOver();
}

function calcRank(score, correct, total){
  const acc = total>0?(correct/total):0;
  const s = score;
  if(s>=5000&&acc>=0.9) return {label:'â˜… LEGEND â˜…',color:'#ffea00'};
  if(s>=3000&&acc>=0.8) return {label:'SS',color:'#ff2d78'};
  if(s>=2000&&acc>=0.7) return {label:'S',color:'#bf00ff'};
  if(s>=1000&&acc>=0.6) return {label:'A',color:'#00f5ff'};
  if(s>=500)             return {label:'B',color:'#39ff14'};
  if(s>=200)             return {label:'C',color:'#e0eaff'};
  if(s>=50)              return {label:'D',color:'#5a6a8a'};
  return                        {label:'E',color:'#3a2a3a'};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer(){
  suc();
  tProbs = qMode==='random'?[...pool].sort(()=>Math.random()-0.5):[...pool];
  tIdx=0; tPaused=false; lastBeepSec=-1;
  document.getElementById('pauseBtn').textContent='â¸ åœæ­¢';
  syncSettings();
  document.getElementById('timerOv').classList.remove('hidden');
  startSessTimer();
  showTQ();
}
function closeTimer(){
  clk(); killTimer(); stopSessTimer();
  document.getElementById('timerOv').classList.add('hidden');
}

function showTQ(){
  tPhase='q';
  const q=tProbs[tIdx];
  document.getElementById('tPhase').textContent='â“ QUESTION';
  document.getElementById('tPhase').className='tphase qp';
  document.getElementById('tQ').textContent=q.q;
  document.getElementById('tCount').textContent=(tIdx+1)+' / '+tProbs.length;
  document.getElementById('cdNum').className='cdnum qc';
  document.getElementById('progFill').className='pfill qf';
  lastBeepSec=-1;
  qStartTime=performance.now();

  // â”€â”€ é¸æŠè‚¢ã‚’å…¨ã¦ã“ã“ã§æ±ºå®šã—ã¦ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ç®¡ç†ï¼ˆæ–‡å­—åˆ—æ¯”è¼ƒãƒã‚°ã‚’å›é¿ï¼‰
  const correctIdx = q.ans;
  const opts = q.opts; // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ãªã„é…åˆ—ã®ã‚³ãƒ”ãƒ¼
  const order = [...opts.keys()].sort(()=>Math.random()-0.5); // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  const labels = ['A','B','C','D'];
  const ta=document.getElementById('tAns');

  // ä¸€æ‹¬ã§HTMLã‚’æ›¸ãæ›ãˆï¼ˆå‰ã®å•é¡Œã®æ®‹åƒãªã—ï¼‰
  ta.innerHTML = order.map((origIdx,i)=>
    `<button class="topt" data-idx="${origIdx}"><span class="topt-lbl">${labels[i]}</span>${opts[origIdx]}</button>`
  ).join('');

  let answered=false;
  ta.querySelectorAll('.topt').forEach(btn=>{
    btn.onclick=()=>{
      if(answered||gLives<=0) return;
      answered=true;
      killTimer();
      const chosen=parseInt(btn.dataset.idx);
      const elapsed=performance.now()-qStartTime;
      // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      ta.querySelectorAll('.topt').forEach(b=>{
        b.disabled=true;
        if(parseInt(b.dataset.idx)===correctIdx) b.classList.add('opt-correct');
        if(b===btn && chosen!==correctIdx)        b.classList.add('opt-wrong');
      });
      if(chosen===correctIdx){ onCorrect(elapsed); }
      else                   { onMiss(); }
      // è§£èª¬
      if(q.exp){
        const d=document.createElement('div');
        d.className='texp-inline'; d.textContent='ğŸ’¡ '+q.exp;
        ta.appendChild(d);
      }
      // è§£ç­”ãƒ•ã‚§ãƒ¼ã‚ºã¸
      tPhase='a';
      document.getElementById('tPhase').textContent='ğŸ’¡ ANSWER';
      document.getElementById('tPhase').className='tphase ap';
      document.getElementById('cdNum').className='cdnum ac';
      document.getElementById('progFill').className='pfill af';
      lastBeepSec=-1;
      if(gLives>0) countdown(tA,nextQ);
    };
  });

  if(!tPaused) countdown(tQ, ()=>timeUp());
}

function timeUp(){
  // æ™‚é–“åˆ‡ã‚Œ = ãƒŸã‚¹æ‰±ã„
  const ta=document.getElementById('tAns');
  const q=tProbs[tIdx];
  ta.querySelectorAll('.topt').forEach(b=>{
    b.disabled=true;
    if(parseInt(b.dataset.idx)===q.ans) b.classList.add('opt-correct');
  });
  if(q.exp){
    const d=document.createElement('div');
    d.className='texp-inline'; d.textContent='ğŸ’¡ '+q.exp;
    ta.appendChild(d);
  }
  onMiss();
  document.getElementById('tPhase').textContent='ğŸ’¡ ANSWER';
  document.getElementById('tPhase').className='tphase ap';
  document.getElementById('cdNum').className='cdnum ac';
  document.getElementById('progFill').className='pfill af';
  lastBeepSec=-1;
  if(gLives>0) countdown(tA,nextQ);
}

function nextQ(){
  tIdx=(tIdx+1)%tProbs.length;
  if(tIdx===0) toast('ğŸ”„ ä¸€å‘¨ã—ã¾ã—ãŸï¼');
  showTQ();
}

function countdown(secs, cb){
  killTimer();
  const dur=secs*1000, t0=performance.now();
  function tick(now){
    const el=Math.max(0,dur-(now-t0));
    const disp=(el/1000).toFixed(1);
    const cdEl=document.getElementById('cdNum');
    cdEl.textContent=disp;
    document.getElementById('progFill').style.width=(el/dur*100)+'%';
    // 0ç§’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã®ã¿ï¼ˆãƒ“ãƒ¼ãƒ—éŸ³ãªã—ï¼‰
    if(el<=0&&lastBeepSec!==0){
      lastBeepSec=0;
      sfxDone(); cdEl.classList.add('warn'); document.getElementById('timerOv').classList.add('timesup-flash');
      setTimeout(()=>{cdEl.classList.remove('warn');document.getElementById('timerOv').classList.remove('timesup-flash');},400);
    }
    if(el<=0){ cb(); return; }
    tRaf=requestAnimationFrame(tick);
  }
  tRaf=requestAnimationFrame(tick);
  tTout=setTimeout(cb,dur);
}
function killTimer(){ clearTimeout(tTout); cancelAnimationFrame(tRaf); tTout=null; tRaf=null; }

function togglePause(){
  clk(); tPaused=!tPaused;
  const b=document.getElementById('pauseBtn');
  if(tPaused){ killTimer(); b.textContent='â–¶ å†é–‹'; }
  else{ b.textContent='â¸ åœæ­¢'; lastBeepSec=-1; if(tPhase==='q') countdown(tQ,()=>timeUp()); else countdown(tA,nextQ); }
}
function skipPhase(){
  clk(); killTimer(); lastBeepSec=-1;
  if(tPhase==='q') timeUp();
  else nextQ();
}
function chTime(t,d){
  clk();
  if(t==='q') tQ=Math.round(Math.max(0.1,Math.min(60,tQ+d))*10)/10;
  else        tA=Math.round(Math.max(0.1,Math.min(60,tA+d))*10)/10;
  syncSettings();
  if(!tPaused&&!document.getElementById('timerOv').classList.contains('hidden')){
    killTimer(); lastBeepSec=-1;
    if(tPhase==='q') countdown(tQ,()=>timeUp()); else countdown(tA,nextQ);
  }
}
function syncSettings(){
  ['tsQ','tsQ2'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=tQ.toFixed(1);});
  ['tsA','tsA2'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent=tA.toFixed(1);});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ac=null;
function ga(){ if(!ac)try{ac=new(window.AudioContext||window.webkitAudioContext)();}catch(e){} if(ac&&ac.state==='suspended')ac.resume(); return ac; }
function tn(f,d,v=0.18,tp='sine'){
  const a=ga();if(!a)return;
  const o=a.createOscillator(),g=a.createGain();
  o.connect(g);g.connect(a.destination);
  o.frequency.value=f;o.type=tp;
  g.gain.setValueAtTime(0,a.currentTime);
  g.gain.linearRampToValueAtTime(v,a.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.001,a.currentTime+d);
  o.start();o.stop(a.currentTime+d);
}
function clk(){ tn(900,0.06,0.1,'square'); }
function suc(){ [523,659,784,1047].forEach((f,i)=>setTimeout(()=>tn(f,0.18,0.12),i*70)); }
function sfxCorrect(){ tn(523,0.08,0.18);setTimeout(()=>tn(784,0.1,0.2),90);setTimeout(()=>tn(1047,0.16,0.18),200); }
function sfxWrong(){ tn(200,0.12,0.22,'sawtooth');setTimeout(()=>tn(150,0.2,0.18,'sawtooth'),120); }
function sfxBeepLow(){ tn(440,0.07,0.1,'sine'); }
function sfxBeepHigh(){ tn(880,0.09,0.18,'sine'); }
function sfxDone(){
  const a=ga();if(!a)return;
  const now=a.currentTime;
  [0,0.07,0.14].forEach(off=>{ const o=a.createOscillator(),g=a.createGain(); o.connect(g);g.connect(a.destination); o.type='sawtooth';o.frequency.value=180; g.gain.setValueAtTime(0,now+off);g.gain.linearRampToValueAtTime(0.4,now+off+0.01);g.gain.exponentialRampToValueAtTime(0.001,now+off+0.06); o.start(now+off);o.stop(now+off+0.07); });
  const o2=a.createOscillator(),g2=a.createGain(); o2.connect(g2);g2.connect(a.destination); o2.type='square';o2.frequency.setValueAtTime(90,now+0.18);o2.frequency.exponentialRampToValueAtTime(40,now+0.7); g2.gain.setValueAtTime(0,now+0.18);g2.gain.linearRampToValueAtTime(0.3,now+0.22);g2.gain.exponentialRampToValueAtTime(0.001,now+0.75); o2.start(now+0.18);o2.stop(now+0.76);
}
function sfxLevelUp(){ [523,659,784,880,1047,1319].forEach((f,i)=>setTimeout(()=>tn(f,0.2,0.18),i*60)); }
function sfxGameOver(){
  const a=ga();if(!a)return;
  const now=a.currentTime;
  [0,0.3,0.6,0.9].forEach((off,i)=>{ const f=[200,180,150,100][i]; const o=a.createOscillator(),g=a.createGain(); o.connect(g);g.connect(a.destination); o.type='sawtooth';o.frequency.value=f; g.gain.setValueAtTime(0,now+off);g.gain.linearRampToValueAtTime(0.3,now+off+0.02);g.gain.exponentialRampToValueAtTime(0.001,now+off+0.28); o.start(now+off);o.stop(now+off+0.3); });
}
function sfxLap(){ [784,659,523].forEach((f,i)=>setTimeout(()=>tn(f,0.15,0.15),i*80)); }

/* â”€â”€ TOAST â”€â”€ */
let tT;
function toast(m){
  const e=document.getElementById('toast');
  e.textContent=m;e.classList.add('show');
  clearTimeout(tT);tT=setTimeout(()=>e.classList.remove('show'),2500);
  if(m.includes('ä¸€å‘¨')) sfxLap();
}

// shake keyframe (inline injection)
const ks=document.createElement('style');
ks.textContent='@keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}';
document.head.appendChild(ks);

document.addEventListener('click',()=>{ if(ac&&ac.state==='suspended')ac.resume(); },{once:true});
</script>
</body>
</html>